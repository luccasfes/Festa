<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <link rel="icon" type="image/x-icon" href="assets/favicon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - FlowLink</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

    <style>
        :root {
            --primary-color: #4e54c8;
            --secondary-color: #8f94fb;
            --accent-color: #00d2ff;
            --dark-bg: #1a1a2e;
            --card-bg: rgba(255, 255, 255, 0.05);
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --success-color: #00b894;
            --danger-color: #ff7675;
            --warning-color: #fdcb6e;
            --glass-border: rgba(255, 255, 255, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: var(--dark-bg);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            overflow-x: hidden;
        }

        /* Animated Background */
        .background-blobs {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
        }

        .blob {
            position: absolute;
            filter: blur(80px);
            opacity: 0.4;
            animation: float 10s infinite alternate;
        }

        .blob-1 { top: 10%; left: 10%; width: 300px; height: 300px; background: var(--primary-color); animation-delay: 0s; }
        .blob-2 { bottom: 20%; right: 10%; width: 250px; height: 250px; background: var(--accent-color); animation-delay: -2s; }
        .blob-3 { bottom: 10%; left: 30%; width: 200px; height: 200px; background: #ff0055; animation-delay: -4s; }

        @keyframes float {
            0% { transform: translate(0, 0); }
            100% { transform: translate(30px, 50px); }
        }

        /* Scrollbar Customization */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a2e; }
        ::-webkit-scrollbar-thumb { background: #4e54c8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #00d2ff; }

        /* Layout & Containers */
        .container {
            width: 100%;
            max-width: 1200px;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: white;
            font-size: 0.9rem;
        }

        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn.primary { background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); }
        .btn.primary:hover { box-shadow: 0 0 15px rgba(78, 84, 200, 0.5); transform: translateY(-2px); }
        .btn.secondary { background: rgba(255, 255, 255, 0.1); border: 1px solid var(--glass-border); }
        .btn.secondary:hover { background: rgba(255, 255, 255, 0.2); }
        .btn.danger { background: rgba(220, 53, 69, 0.2); border: 1px solid rgba(220, 53, 69, 0.3); color: #ff6b6b; }
        .btn.danger:hover { background: rgba(220, 53, 69, 0.4); }
        .btn.small { padding: 6px 12px; font-size: 0.8rem; }

        /* Login View */
        .login-card {
            max-width: 400px;
            margin: 10vh auto;
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(16px);
            padding: 40px;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            text-align: center;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; margin-bottom: 8px; font-size: 0.9rem; color: var(--text-secondary); }
        .input-group input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            background: rgba(0, 0, 0, 0.2);
            color: white;
            outline: none;
            transition: var(--transition);
        }
        .input-group input:focus { border-color: var(--accent-color); box-shadow: 0 0 0 2px rgba(0, 210, 255, 0.1); }

        /* Dashboard Stats */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 16px;
            border: 1px solid var(--glass-border);
            text-align: center;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover { transform: translateY(-5px); border-color: var(--accent-color); }
        .stat-value { font-size: 2.5rem; font-weight: 700; color: white; margin: 10px 0; }
        .stat-label { color: var(--text-secondary); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }

        /* Controls & Room List */
        .controls-container {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            border: 1px solid var(--glass-border);
        }

        .search-box { flex: 1; min-width: 250px; position: relative; }
        .search-box input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--glass-border);
            color: white;
        }
        .search-box i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); }

        .filter-select {
            padding: 10px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--glass-border);
            color: white;
            cursor: pointer;
        }

        .room-list { list-style: none; }
        .room-item {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--glass-border);
            margin-bottom: 15px;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: var(--transition);
        }

        .room-item:hover { background: rgba(255, 255, 255, 0.05); border-color: rgba(255, 255, 255, 0.2); }
        
        .room-info h4 { font-size: 1.1rem; margin-bottom: 5px; display: flex; align-items: center; gap: 10px; }
        .room-meta { display: flex; gap: 15px; font-size: 0.85rem; color: var(--text-secondary); margin: 5px 0 10px 0; }
        
        .room-stats-badges { display: flex; gap: 8px; }
        .badge {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
        }
        .badge i { margin-right: 4px; color: var(--accent-color); }

        .room-actions { display: flex; gap: 8px; }

        .activity-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .dot-high { background: var(--success-color); box-shadow: 0 0 8px var(--success-color); }
        .dot-med { background: var(--warning-color); }
        .dot-low { background: var(--danger-color); }

        /* Modals */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.active { opacity: 1; pointer-events: all; }

        .modal {
            background: #1e1e2e;
            width: 90%;
            max-width: 600px;
            border-radius: 16px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            transform: translateY(20px);
            transition: transform 0.3s ease;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }
        .modal-overlay.active .modal { transform: translateY(0); }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-body { padding: 20px; overflow-y: auto; }
        .modal-footer { padding: 20px; border-top: 1px solid var(--glass-border); display: flex; justify-content: flex-end; gap: 10px; }

        .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .detail-row { display: flex; flex-direction: column; }
        .detail-label { font-size: 0.8rem; color: var(--text-secondary); }
        .detail-val { font-size: 1rem; color: white; font-weight: 500; }

        /* Toast */
        .toast {
            position: fixed; top: 20px; right: 20px;
            padding: 15px 20px;
            background: #333;
            color: white;
            border-radius: 8px;
            display: flex; align-items: center; gap: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transform: translateX(120%);
            transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 2000;
        }
        .toast.show { transform: translateX(0); }
        .toast.success { background: var(--success-color); }
        .toast.error { background: var(--danger-color); }
        .toast.info { background: var(--primary-color); }

        /* Responsividade */
        @media (max-width: 768px) {
            .room-item { flex-direction: column; align-items: flex-start; gap: 15px; }
            .room-actions { width: 100%; justify-content: flex-end; }
            .controls-container { flex-direction: column; align-items: stretch; }
            .stat-value { font-size: 2rem; }
        }

        .loading-spinner {
            border: 3px solid rgba(255,255,255,0.1);
            border-top: 3px solid var(--accent-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>

<body>
    <div class="background-blobs">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>

    <div id="toast" class="toast"></div>

    <div class="container">
        <main id="loginView">
            <div class="login-card">
                <i class="fas fa-shield-alt" style="font-size: 3rem; color: var(--accent-color); margin-bottom: 20px;"></i>
                <h2>Admin FlowLink</h2>
                <p style="color: var(--text-secondary); margin-bottom: 30px;">Acesso restrito a gerenciadores.</p>

                <div class="input-group">
                    <label>E-mail</label>
                    <input type="email" id="adminEmail" placeholder="admin@flowlink.com">
                </div>
                <div class="input-group">
                    <label>Senha</label>
                    <input type="password" id="adminPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>

                <button class="btn primary" style="width: 100%; justify-content: center;" onclick="adminLogin()" id="btnLogin">
                    <span>Entrar</span>
                </button>
            </div>
        </main>

        <main id="dashboardView" style="display: none;">
            <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <div>
                    <h1 style="font-weight: 600;"><i class="fas fa-tachometer-alt"></i> Dashboard</h1>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">Gerenciamento em tempo real</p>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span id="adminEmailDisplay" style="color: var(--text-secondary); font-size: 0.9rem;"></span>
                    <button class="btn secondary small" onclick="adminLogout()">
                        <i class="fas fa-sign-out-alt"></i> Sair
                    </button>
                </div>
            </header>

            <div class="stats-container">
                <div class="stat-card">
                    <i class="fas fa-door-open" style="color: var(--accent-color); font-size: 1.5rem; margin-bottom: 10px;"></i>
                    <div class="stat-value" id="totalRooms">0</div>
                    <div class="stat-label">Salas Ativas</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-users" style="color: var(--success-color); font-size: 1.5rem; margin-bottom: 10px;"></i>
                    <div class="stat-value" id="totalUsers">0</div>
                    <div class="stat-label">Usu√°rios Online</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-film" style="color: #ff7675; font-size: 1.5rem; margin-bottom: 10px;"></i>
                    <div class="stat-value" id="totalVideos">0</div>
                    <div class="stat-label">V√≠deos na Fila</div>
                </div>
            </div>

            <div class="controls-container">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Buscar por ID, nome ou criador...">
                </div>
                <select class="filter-select" id="sortFilter">
                    <option value="newest">Mais Recentes</option>
                    <option value="oldest">Mais Antigas</option>
                    <option value="mostUsers">Mais Usu√°rios</option>
                </select>
                <button class="btn secondary" onclick="loadActiveRooms()">
                    <i class="fas fa-sync-alt"></i> Atualizar
                </button>
                <button class="btn danger" onclick="confirmDeleteAllRooms()">
                    <i class="fas fa-trash-alt"></i> Limpar Tudo
                </button>
            </div>

            <ul id="roomList" class="room-list">
                <li style="text-align: center; padding: 40px; color: var(--text-secondary);">
                    <div class="loading-spinner"></div> Carregando salas...
                </li>
            </ul>
        </main>
    </div>

    <div class="modal-overlay" id="confirmModal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h3><i class="fas fa-exclamation-triangle" style="color: var(--warning-color);"></i> Confirma√ß√£o</h3>
                <button class="btn secondary small" onclick="closeModal('confirmModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" id="confirmBody">
                Tem certeza?
            </div>
            <div class="modal-footer">
                <button class="btn secondary" onclick="closeModal('confirmModal')">Cancelar</button>
                <button class="btn danger" id="btnConfirmAction">Confirmar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="detailsModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-info-circle"></i> Detalhes da Sala</h3>
                <button class="btn secondary small" onclick="closeModal('detailsModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="detail-grid">
                    <div class="detail-row">
                        <span class="detail-label">Nome</span>
                        <span class="detail-val" id="detName">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">ID (Clique para copiar)</span>
                        <span class="detail-val" id="detId" style="cursor: pointer; color: var(--accent-color);" onclick="copyToClipboard(this.innerText)">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Criador</span>
                        <span class="detail-val" id="detCreator">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Criada em</span>
                        <span class="detail-val" id="detCreated">-</span>
                    </div>
                </div>
                
                <h4 style="margin: 20px 0 10px; border-bottom: 1px solid var(--glass-border); padding-bottom: 5px;">Usu√°rios</h4>
                <div id="detUsersList" style="margin-bottom: 20px;"></div>

                <h4 style="margin: 20px 0 10px; border-bottom: 1px solid var(--glass-border); padding-bottom: 5px;">Fila de V√≠deos</h4>
                <div id="detVideoList"></div>
            </div>
            <div class="modal-footer">
                <a href="#" target="_blank" id="detLinkBtn" class="btn primary"><i class="fas fa-external-link-alt"></i> Entrar</a>
                <button class="btn danger" id="detDeleteBtn"><i class="fas fa-trash"></i> Deletar</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURA√á√ÉO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCDlr4XHXuwWQ9Zj9dd2yoctLhFz1vbbyM",
            authDomain: "flowlink-7fd57.firebaseapp.com",
            databaseURL: "https://flowlink-7fd57-default-rtdb.firebaseio.com",
            projectId: "flowlink-7fd57",
            storageBucket: "flowlink-7fd57.firebasestorage.app",
            messagingSenderId: "1035085936175",
            appId: "1:1035085936175:web:2732042d77792118b8f8da",
            measurementId: "G-B0NE1GDVQK"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        const roomsRef = database.ref('rooms');

        // ATEN√á√ÉO: Verifica√ß√£o Client-Side √© insegura. Use Firebase Security Rules para prote√ß√£o real.
        const ADMIN_UIDS = [
            'PTkwuSLcpaRvtVWOzJH79NrwReA2',
            'liOoyPGRKHgYX1Q81irll97kBSD3',
            'QwUYZ2Ls20fDtlUFDXs5lKjouN12'
        ];

        // Estado Global
        let roomsData = {};
        let currentAction = null;

        // Elementos DOM
        const els = {
            loginView: document.getElementById('loginView'),
            dashboardView: document.getElementById('dashboardView'),
            roomList: document.getElementById('roomList'),
            searchInput: document.getElementById('searchInput'),
            sortFilter: document.getElementById('sortFilter'),
            stats: {
                rooms: document.getElementById('totalRooms'),
                users: document.getElementById('totalUsers'),
                videos: document.getElementById('totalVideos')
            }
        };

        // --- AUTH ---
        auth.onAuthStateChanged(user => {
            if (user && ADMIN_UIDS.includes(user.uid)) {
                els.loginView.style.display = 'none';
                els.dashboardView.style.display = 'block';
                document.getElementById('adminEmailDisplay').textContent = user.email;
                loadActiveRooms();
            } else {
                els.loginView.style.display = 'block';
                els.dashboardView.style.display = 'none';
                if(user) {
                    showToast('Acesso negado: Conta n√£o administrativa.', 'error');
                    auth.signOut();
                }
            }
        });

        function adminLogin() {
            const email = document.getElementById('adminEmail').value;
            const pass = document.getElementById('adminPassword').value;
            const btn = document.getElementById('btnLogin');

            if(!email || !pass) return showToast('Preencha todos os campos', 'info');

            btn.disabled = true;
            btn.innerHTML = '<div class="loading-spinner"></div>';

            auth.signInWithEmailAndPassword(email, pass)
                .catch(err => {
                    showToast('Erro: ' + err.message, 'error');
                    btn.disabled = false;
                    btn.textContent = 'Entrar';
                });
        }

        function adminLogout() {
            auth.signOut();
        }

        // --- CORE FUNCTIONS ---
        function loadActiveRooms() {
            // Loading state suave
            els.roomList.style.opacity = '0.5';

            roomsRef.once('value', snapshot => {
                els.roomList.style.opacity = '1';
                els.roomList.innerHTML = '';
                roomsData = {}; // Reset

                if (!snapshot.exists()) {
                    renderEmptyState();
                    updateStats(0, 0, 0);
                    return;
                }

                let totalUsers = 0, totalVideos = 0;
                let roomsArray = [];

                snapshot.forEach(child => {
                    const room = child.val();
                    const id = child.key;
                    roomsData[id] = room;

                    const userCount = room.presence ? Object.keys(room.presence).length : 0;
                    const videoCount = room.videoQueue ? Object.keys(room.videoQueue).length : 0;

                    totalUsers += userCount;
                    totalVideos += videoCount;

                    roomsArray.push({
                        id,
                        ...room,
                        userCount,
                        videoCount
                    });
                });

                updateStats(roomsArray.length, totalUsers, totalVideos);
                
                // Filtragem e Ordena√ß√£o
                const filtered = filterAndSortRooms(roomsArray);
                
                // Renderiza√ß√£o Otimizada com DocumentFragment
                const fragment = document.createDocumentFragment();
                
                filtered.forEach(room => {
                    const li = document.createElement('li');
                    li.className = 'room-item';
                    
                    // L√≥gica de atividade
                    let dotClass = 'dot-low';
                    if (room.userCount > 5) dotClass = 'dot-high';
                    else if (room.userCount > 0) dotClass = 'dot-med';

                    li.innerHTML = `
                        <div class="room-info">
                            <h4>
                                <span class="activity-dot ${dotClass}"></span>
                                ${escapeHtml(room.roomName || 'Sem nome')}
                            </h4>
                            <div class="room-meta">
                                <span><i class="fas fa-crown"></i> ${escapeHtml(room.creatorName || '?')}</span>
                                <span><i class="fas fa-clock"></i> ${formatDate(room.createdAt)}</span>
                                <span style="cursor:pointer" onclick="copyToClipboard('${room.id}')" title="Copiar ID"><i class="fas fa-fingerprint"></i> ${room.id.substring(0,6)}...</span>
                            </div>
                            <div class="room-stats-badges">
                                <span class="badge"><i class="fas fa-users"></i> ${room.userCount}</span>
                                <span class="badge"><i class="fas fa-film"></i> ${room.videoCount}</span>
                            </div>
                        </div>
                        <div class="room-actions">
                            <button class="btn secondary small" onclick="openDetails('${room.id}')">Detalhes</button>
                            <button class="btn danger small" onclick="askDeleteRoom('${room.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    fragment.appendChild(li);
                });

                if(filtered.length === 0) renderEmptyState("Nenhuma sala encontrada com este filtro.");
                else els.roomList.appendChild(fragment);
            });
        }

        function filterAndSortRooms(rooms) {
            const term = els.searchInput.value.toLowerCase();
            const sort = els.sortFilter.value;

            // Filtro
            let filtered = rooms.filter(r => 
                (r.roomName && r.roomName.toLowerCase().includes(term)) ||
                (r.id && r.id.toLowerCase().includes(term)) ||
                (r.creatorName && r.creatorName.toLowerCase().includes(term))
            );

            // Sort
            filtered.sort((a, b) => {
                if (sort === 'newest') return (b.createdAt || 0) - (a.createdAt || 0);
                if (sort === 'oldest') return (a.createdAt || 0) - (b.createdAt || 0);
                if (sort === 'mostUsers') return b.userCount - a.userCount;
                return 0;
            });

            return filtered;
        }

        // --- ACTIONS ---
        function askDeleteRoom(roomId) {
    const room = roomsData[roomId];
    
    // üî¥ BLOQUEIO: Se tiver gente online, nem abre o modal
    if (room && room.presence && Object.keys(room.presence).length > 0) {
        showToast("Prote√ß√£o: N√£o √© poss√≠vel deletar sala com usu√°rios online!", "error");
        return; 
    }

    currentAction = () => {
        database.ref('rooms/' + roomId).remove()
            .then(() => {
                showToast('Sala deletada com sucesso!', 'success');
                // O listener once/on vai atualizar a tela sozinho
            })
            .catch(e => {
                // Aqui pegamos o erro que vir√° das Regras de Seguran√ßa do Firebase
                console.error(e);
                showToast("Erro: Voc√™ n√£o tem permiss√£o de Admin (Backend).", "error");
            });
    };
    
    document.getElementById('confirmBody').innerHTML = `
        Deletar a sala <strong>${room.roomName || roomId}</strong> permanentemente?<br>
        <small style="color: var(--text-secondary)">Hist√≥rico e fila ser√£o perdidos.</small>
    `;
    
    // Configura o bot√£o do modal e abre
    const confirmBtn = document.getElementById('btnConfirmAction');
    confirmBtn.onclick = () => {
        currentAction();
        closeModal('confirmModal');
    };
    
    openModal('confirmModal');
}
        function confirmDeleteAllRooms() {
            currentAction = () => {
                database.ref('rooms').remove()
                    .then(() => showToast('Todas as salas foram limpas.', 'success'))
                    .catch(e => showToast(e.message, 'error'));
            };
            document.getElementById('confirmBody').innerHTML = `<span style="color: #ff7675">ATEN√á√ÉO:</span> Voc√™ vai apagar TODAS as salas e dados ativos.`;
            document.getElementById('btnConfirmAction').onclick = () => {
                currentAction();
                closeModal('confirmModal');
            };
            openModal('confirmModal');
        }

        function openDetails(roomId) {
            const room = roomsData[roomId];
            if(!room) return;

            // Preencher dados
            document.getElementById('detName').textContent = room.roomName || 'Sem nome';
            document.getElementById('detId').textContent = roomId;
            document.getElementById('detCreator').textContent = room.creatorName || '-';
            document.getElementById('detCreated').textContent = new Date(room.createdAt).toLocaleString('pt-BR');
            document.getElementById('detLinkBtn').href = `index.html?room=${roomId}`;
            
            // Bot√£o Deletar no Modal
            document.getElementById('detDeleteBtn').onclick = () => {
                closeModal('detailsModal');
                askDeleteRoom(roomId);
            };

            // Listar Users
            const usersDiv = document.getElementById('detUsersList');
            usersDiv.innerHTML = '';
            if(room.presence) {
                Object.values(room.presence).forEach(u => {
                    usersDiv.innerHTML += `<div style="font-size:0.9rem; padding: 4px 0;"><i class="fas fa-user-circle"></i> ${escapeHtml(u.name)}</div>`;
                });
            } else {
                usersDiv.innerHTML = '<span style="color:var(--text-secondary); font-size: 0.8rem;">Ningu√©m online</span>';
            }

            // Listar V√≠deos (Top 3)
            const videoDiv = document.getElementById('detVideoList');
            videoDiv.innerHTML = '';
            if(room.videoQueue) {
                const videos = Object.values(room.videoQueue);
                videos.slice(0, 3).forEach(v => {
                    videoDiv.innerHTML += `
                        <div style="background: rgba(0,0,0,0.2); padding: 8px; margin-bottom: 5px; border-radius: 4px; font-size: 0.85rem;">
                            <div style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${v.videoUrl}</div>
                            <small style="color: var(--text-secondary)">Por: ${escapeHtml(v.phone)}</small>
                        </div>
                    `;
                });
                if(videos.length > 3) videoDiv.innerHTML += `<small>+ ${videos.length - 3} outros v√≠deos...</small>`;
            } else {
                videoDiv.innerHTML = '<span style="color:var(--text-secondary); font-size: 0.8rem;">Fila vazia</span>';
            }

            openModal('detailsModal');
        }

        // --- UTILS ---
        function updateStats(r, u, v) {
            els.stats.rooms.innerText = r;
            els.stats.users.innerText = u;
            els.stats.videos.innerText = v;
        }

        function renderEmptyState(msg = "Nenhuma sala ativa no momento.") {
            els.roomList.innerHTML = `
                <div style="text-align: center; padding: 50px; color: var(--text-secondary);">
                    <i class="fas fa-wind" style="font-size: 3rem; margin-bottom: 20px; opacity: 0.5;"></i>
                    <p>${msg}</p>
                </div>
            `;
        }

        // Modais
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        // Fechar com ESC ou Clicar fora
        window.onclick = (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                e.target.classList.remove('active');
            }
        };
        document.addEventListener('keydown', (e) => {
            if(e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
            }
        });

        // Toast System
        function showToast(msg, type = 'info') {
            const t = document.getElementById('toast');
            let icon = 'info-circle';
            if(type === 'success') icon = 'check-circle';
            if(type === 'error') icon = 'times-circle';

            t.className = `toast ${type} show`;
            t.innerHTML = `<i class="fas fa-${icon}"></i> ${msg}`;
            
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => showToast('ID copiado!', 'success'));
        }

        function escapeHtml(text) {
            if (!text) return text;
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        function formatDate(timestamp) {
            if(!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
        }

        // Listeners
        els.searchInput.addEventListener('input', () => loadActiveRooms());
        els.sortFilter.addEventListener('change', () => loadActiveRooms());

    </script>
</body>
</html>