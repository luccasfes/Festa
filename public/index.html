<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Video Queue App</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.youtube.com/iframe_api"></script>
</head>
<body>
    <div class="container">
        <div class="input-section">
            <h1>Adicionar Vídeo</h1>
            <input type="text" id="phone" placeholder="Nome" required>
            <input type="text" id="videoUrl" placeholder="URL do Vídeo" required>
            <button onclick="addVideo()">Adicionar</button>
        </div>

        <div class="main-content">
            <div class="video-section">
                <h2>Vídeo em Execução</h2>
                <div id="player-container">
                    <div id="videoPlayer"></div>
                </div>
                <div id="currentVideoInfo">
                    <h3>Quem está tocando:</h3>
                    <p id="currentUser">Nenhum vídeo em execução</p>
                    <p id="currentVideoUrl">Nenhuma URL disponível</p>
                </div>
            </div>

            <div class="queue-section">
                <h2>Fila de Vídeos</h2>
                <ul id="videoList"></ul>
            </div>
        </div>
    </div>

    <script>
        let videoQueue = [];
        let player;
        let currentVideoIndex = 0;

        async function addVideo() {
            const phone = document.getElementById('phone').value;
            const videoUrl = document.getElementById('videoUrl').value;

            await fetch('/add-video', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ phone, videoUrl })
            });

            alert('Vídeo adicionado!');
            document.getElementById('phone').value = '';
            document.getElementById('videoUrl').value = '';
            loadVideoQueue();
        }

        async function loadVideoQueue() {
            const response = await fetch('/queue');
            videoQueue = await response.json();
            const videoList = document.getElementById('videoList');
            videoList.innerHTML = '';

            videoQueue.forEach(video => {
                const listItem = document.createElement('li');
                listItem.textContent = `Nome: ${video.phone}, URL: ${video.videoUrl}`;
                videoList.appendChild(listItem);
            });

            // Inicia a reprodução do primeiro vídeo se o player estiver pronto
            if (videoQueue.length > 0 && player) {
                const videoId = new URL(videoQueue[currentVideoIndex].videoUrl).searchParams.get('v');
                if (player.getVideoData().video_id !== videoId) {
                    updateVideoPlayer(videoQueue[currentVideoIndex].videoUrl);
                }
            }
        }

        function updateVideoPlayer(videoUrl) {
            const videoId = new URL(videoUrl).searchParams.get('v');
            if (player) {
                player.loadVideoById(videoId);
                document.getElementById('currentUser').textContent = videoQueue[currentVideoIndex].phone;
                document.getElementById('currentVideoUrl').textContent = videoUrl;
            } else {
                console.error('Player is not ready yet.');
            }
        }

        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.ENDED) {
                currentVideoIndex++;
                if (currentVideoIndex < videoQueue.length) {
                    updateVideoPlayer(videoQueue[currentVideoIndex].videoUrl);
                } else {
                    currentVideoIndex = 0;
                    if (videoQueue.length > 0) {
                        updateVideoPlayer(videoQueue[currentVideoIndex].videoUrl);
                    } else {
                        player.stopVideo();
                        document.getElementById('currentUser').textContent = 'Nenhum vídeo em execução';
                        document.getElementById('currentVideoUrl').textContent = 'Nenhuma URL disponível';
                    }
                }
            }
        }

        window.onload = loadVideoQueue;

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('videoPlayer', {
                height: '315',
                width: '560',
                events: {
                    'onReady': (event) => {
                        loadVideoQueue();
                        if (videoQueue.length > 0) {
                            updateVideoPlayer(videoQueue[currentVideoIndex].videoUrl);
                        }
                    },
                    'onStateChange': onPlayerStateChange
                }
            });
        }
    </script>
    
</body>
</html>
