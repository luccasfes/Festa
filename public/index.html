<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <link rel="icon" type="image/x-icon" href="assets/favicon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowLink</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.youtube.com/iframe_api"></script>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

    <link rel="stylesheet" href="style.css">
</head>

<body class="non-admin">
    <div id="particles"></div>
    <div class="container">
        <header class="app-header">
            <button class="btn small" id="adminUnlockBtn" onclick="openAdminUnlockModal()">
                <i class="fas fa-lock"></i> Admin
            </button>

            <h1><i class="fas fa-music"></i> FlowLink<i class="fas fa-headphones"></i></h1>

            <div class="presence-indicator">
                <i class="fas fa-users"></i>
                <span id="userCount">0</span> online
            </div>
        </header>

        <main class="main-layout">
            <section class="input-section card">
                <h2><i class="fas fa-plus-circle"></i> Adicionar V√≠deo</h2>
                <div class="input-group">
                    <label for="phone"><i class="fas fa-user"></i> Nome:</label>
                    <input type="text" id="phone" placeholder="Quem adicionou?" required>
                </div>
                <div class="input-group">
                    <label for="videoUrl"><i class="fab fa-youtube"></i> URL do V√≠deo:</label>
                    <input type="text" id="videoUrl" placeholder="Link do YouTube" required>
                </div>
                <button class="btn primary" onclick="addVideo()" id="addVideoBtn">
                    <span id="addBtnText">Adicionar √† Fila</span>
                    <span id="addBtnLoader" class="loading" style="display: none;"></span>
                </button>
                <button class="btn youtube" onclick="openYTSearchModal()">
                    <i class="fab fa-youtube"></i> Buscar no YouTube
                </button>


            </section>


            <section class="video-player-section card">
                <h2><i class="fas fa-play-circle"></i> V√≠deo em Execu√ß√£o</h2>
                <div id="player-container">
                    <div id="videoPlayer"></div>

                    <!-- m√°scara que bloqueia intera√ß√µes com a barra nativa (continua presente) -->
                    <div id="player-mask"></div>

                    <!-- Controles personalizados (play/pause + volume). Vis√≠veis apenas para non-admin -->
                    <div class="player-overlay-controls" aria-hidden="false">
                        <button id="overlayPlayBtn" title="Play/Pause"><i id="overlayPlayIcon"
                                class="fas fa-play"></i></button>
                        <label for="overlayVolume" style="color:var(--text-secondary);font-size:0.9rem;">Vol</label>
                        <input id="overlayVolume" type="range" min="0" max="100" step="1" value="50"
                            aria-label="Volume">
                        <button id="overlayFullscreenBtn" title="Tela cheia"><i class="fas fa-expand"></i></button>
                    </div>

                </div>


                <div id="currentVideoInfo">
                    <h3>Escolha de: <span id="currentUser">Nenhum v√≠deo em execu√ß√£o</span></h3>
                    <p class="current-url" id="currentVideoUrl">Nenhuma URL dispon√≠vel</p>
                </div>
                <button class="btn primary skip-video-button" onclick="handleSkipVideo()">
                    <i class="fas fa-forward"></i> Pular para o Pr√≥ximo V√≠deo
                </button>
            </section>

            <section class="queue-section card">
                <h2>
                    <i class="fas fa-list-ol"></i> Fila de M√∫sica
                    <button class="btn danger clear-queue-button" onclick="handleClearQueue()">
                        <i class="fas fa-trash-alt"></i> Limpar Fila
                    </button>
                    <button class="btn bulk-remove-button" onclick="removeSelectedVideos()" id="bulkRemoveBtn"
                        style="display: none;">
                        <i class="fas fa-eraser"></i> Remover Selecionados
                    </button>
                </h2>
                <ul id="videoList" class="video-queue-list"></ul>
            </section>
        </main>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">√ó</span>
            <h3><i class="fas fa-trash-alt"></i> Limpar Fila</h3>
            <p>Digite seu nome e a senha para limpar a fila.</p>
            <div class="input-group">
                <label for="adminName"><i class="fas fa-user-shield"></i> E-mail do Admin:</label>
                <input type="email" id="adminName" placeholder="Seu e-mail" required>
            </div>
            <div class="input-group password-group">
                <label for="clearPassword"><i class="fas fa-lock"></i> Senha:</label>
                <input type="password" id="clearPassword" placeholder="Senha de administrador" required>
                <span class="toggle-password" id="togglePassword"><i class="fas fa-eye"></i></span>
            </div>
            <button class="btn primary" onclick="clearQueue()" id="clearQueueBtn">
                <span id="clearBtnText">Confirmar Limpeza</span>
                <span id="clearBtnLoader" class="loading" style="display: none;"></span>
            </button>
        </div>
    </div>

    <div id="removeModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeRemoveModal()">√ó</span>
            <h3><i class="fas fa-trash"></i> Remover V√≠deo</h3>
            <p>Digite seu nome e a senha para remover o v√≠deo selecionado.</p>
            <div class="input-group">
                <label for="removeAdminName"><i class="fas fa-user-shield"></i> E-mail do Admin:</label>
                <input type="email" id="removeAdminName" placeholder="Seu e-mail" required>
            </div>
            <div class="input-group password-group">
                <label for="removePassword"><i class="fas fa-lock"></i> Senha:</label>
                <input type="password" id="removePassword" placeholder="Senha de administrador" required>
                <span class="toggle-password" id="toggleRemovePassword"><i class="fas fa-eye"></i></span>
            </div>
            <button class="btn primary" onclick="removeVideo()" id="removeVideoBtn">
                <span id="removeBtnText">Confirmar Remo√ß√£o</span>
                <span id="removeBtnLoader" class="loading" style="display: none;"></span>
            </button>
        </div>
    </div>

    <div id="ytSearchModal" class="modal yt-search-modal">
        <div class="modal-content">

            <div class="modal-header">
                <h3><i class="fab fa-youtube"></i> Buscar V√≠deo no YouTube</h3>
                <button class="close-button" onclick="closeYTSearchModal()">&times;</button>
            </div>

            <div class="modal-body">

                <div class="session-info input-group">
                    <label><i class="fas fa-user"></i> Adicionando como: <strong
                            id="currentSessionUser">-</strong></label>
                    <button class="btn small secondary" onclick="changeUserName()">Alterar</button>
                </div>

                <div id="userNameInputGroup" class="input-group">
                    <label for="ytSearchName"><i class="fas fa-user"></i> Seu Nome:</label>
                    <input type="text" id="ytSearchName" placeholder="Quem est√° adicionando?">
                    <button class="btn small primary" onclick="setSessionUser()">Confirmar</button>
                </div>

                <div class="search-controls">
                    <input type="text" id="ytSearchQuery" placeholder="Digite sua busca">
                    <button class="btn primary" onclick="searchYouTube()">
                        <i class="fas fa-search"></i> Buscar
                    </button>
                </div>

                <div class="yt-search-results" id="ytSearchResults">
                </div>

            </div>
        </div>
    </div>

    <div id="notification" class="notification">
        <span id="notificationMessage"></span>
    </div>

    <!-- Proxiam faixa -->
    <div id="nextVideoModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeNextVideoModal()">√ó</span>
            <h3><i class="fas fa-forward"></i> Pr√≥ximo V√≠deo</h3>
            <p>Digite seu nome e a senha de administrador para pular para o pr√≥ximo v√≠deo.</p>
            <div class="input-group">
                <label for="nextAdminName"><i class="fas fa-user-shield"></i> E-mail do Admin:</label>
                <input type="email" id="nextAdminName" placeholder="Seu e-mail" required>
            </div>
            <div class="input-group password-group">
                <label for="nextPassword"><i class="fas fa-lock"></i> Senha:</label>
                <input type="password" id="nextPassword" placeholder="Senha de administrador" required>
                <span class="toggle-password" id="toggleNextPassword"><i class="fas fa-eye"></i></span>
            </div>
            <button class="btn primary" onclick="playNextVideo()" id="playNextVideoBtn">
                <span id="playNextBtnText">Confirmar Pr√≥ximo</span>
                <span id="playNextBtnLoader" class="loading" style="display: none;"></span>
            </button>
        </div>
    </div>

    <div id="adminUnlockModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeAdminUnlockModal()">√ó</span>
            <h3><i class="fas fa-user-shield"></i> Login de Administrador</h3>
            <p>Digite suas credenciais para entrar no Modo Admin.</p>
            <div class="input-group">
                <label for="adminUnlockName"><i class="fas fa-user-shield"></i> E-mail do Admin:</label>
                <input type="email" id="adminUnlockName" placeholder="Seu e-mail" required>
            </div>
            <div class="input-group password-group">
                <label for="adminUnlockPassword"><i class="fas fa-lock"></i> Senha:</label>
                <input type="password" id="adminUnlockPassword" placeholder="Senha de administrador" required>
                <span class="toggle-password" id="toggleAdminUnlockPassword"><i class="fas fa-eye"></i></span>
            </div>
            <button class="btn primary" onclick="loginAdminSession()" id="adminUnlockConfirmBtn">
                <span id="adminUnlockBtnText">Login</span>
                <span id="adminUnlockBtnLoader" class="loading" style="display: none;"></span>
            </button>
        </div>
    </div>

    <div id="bulkRemoveConfirmModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeBulkRemoveConfirmModal()">√ó</span>
            <h3><i class="fas fa-exclamation-triangle"></i> Confirmar Remo√ß√£o</h3>
            <p id="bulkRemoveMessage">Tem certeza que deseja remover os v√≠deos selecionados?</p>

            <div class="modal-buttons">
                <button class="btn secondary" onclick="closeBulkRemoveConfirmModal()">
                    Cancelar
                </button>
                <button class="btn danger" onclick="executeBulkRemove()" id="bulkRemoveConfirmBtn">
                    <span id="bulkRemoveConfirmBtnText">Remover</span>
                    <span id="bulkRemoveConfirmBtnLoader" class="loading" style="display: none;"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- //sess√£o -->
    <script>
        let currentSessionUser = null;

        function openYTSearchModal() {
            document.getElementById('ytSearchModal').style.display = 'flex';
            document.getElementById('ytSearchQuery').value = '';
            document.getElementById('ytSearchResults').innerHTML = '';

            // Mostra a interface apropriada baseada no estado
            if (currentSessionUser) {
                document.getElementById('currentSessionUser').textContent = currentSessionUser;
                document.getElementById('userNameInputGroup').style.display = 'none';
                document.querySelector('.session-info').style.display = 'flex';
                document.getElementById('ytSearchQuery').focus();
            } else {
                document.getElementById('userNameInputGroup').style.display = 'block';
                document.querySelector('.session-info').style.display = 'none';
                document.getElementById('ytSearchName').focus();
            }
        }

        function setSessionUser() {
            const userName = document.getElementById('ytSearchName').value.trim();

            if (!userName) {
                showNotification('Por favor, digite seu nome.', 'error');
                return;
            }

            currentSessionUser = userName;
            document.getElementById('currentSessionUser').textContent = userName;
            document.getElementById('userNameInputGroup').style.display = 'none';
            document.querySelector('.session-info').style.display = 'flex';
            document.getElementById('ytSearchQuery').focus();

            // Salva na sessionStorage para persistir entre recarregamentos
            sessionStorage.setItem('ytSessionUser', userName);

            // *** NOVA LINHA: Atualiza o nome na lista de presen√ßa ***
            if (myPresenceRef) {
                myPresenceRef.update({ name: userName });
            }
        }

        function changeUserName() {
            currentSessionUser = null;
            sessionStorage.removeItem('ytSessionUser');
            document.getElementById('ytSearchName').value = '';
            document.getElementById('userNameInputGroup').style.display = 'block';
            document.querySelector('.session-info').style.display = 'none';
            document.getElementById('ytSearchName').focus();

            // *** NOVA LINHA: Atualiza o nome para "Visitante" ***
            if (myPresenceRef) {
                myPresenceRef.update({ name: 'Visitante' });
            }
        }

        // Ao carregar a p√°gina, verifica se h√° um nome salvo
        window.addEventListener('DOMContentLoaded', function () {
            const savedUser = sessionStorage.getItem('ytSessionUser');
            if (savedUser) {
                currentSessionUser = savedUser;
            }
        });
    </script>
    <script>

        // ====================================================================
        // Fun√ß√µes para o modal de busca no YouTube
        function openYTSearchModal() {
            document.getElementById('ytSearchModal').style.display = 'flex';
            document.getElementById('ytSearchQuery').focus();
        }

        function closeYTSearchModal() {
            document.getElementById('ytSearchModal').style.display = 'none';
            document.getElementById('ytSearchQuery').value = '';
            document.getElementById('ytSearchResults').innerHTML = '';
        }

        function selectYouTubeVideo(videoUrl, videoTitle) {
            // Verifica se temos um usu√°rio na sess√£o
            if (!currentSessionUser) {
                showNotification('Por favor, configure seu nome antes de adicionar v√≠deos.', 'error');
                // Mostra o campo de nome e foca nele
                document.getElementById('userNameInputGroup').style.display = 'block';
                document.querySelector('.session-info').style.display = 'none';
                document.getElementById('ytSearchName').focus();
                return;
            }

            // Preenche os campos no formul√°rio principal automaticamente
            document.getElementById('phone').value = currentSessionUser;
            document.getElementById('videoUrl').value = videoUrl;

            // N√£o fecha o modal - permite adicionar mais v√≠deos
            // Mant√©m o modal aberto para continuar adicionando

            // Adiciona o v√≠deo √† fila
            setTimeout(() => {
                addVideo();

                // Feedback visual que o v√≠deo foi adicionado
                showNotification(`"${videoTitle}" adicionado por ${currentSessionUser}`, 'success');

                // Rolagem suave para o resultado adicionado
                setTimeout(() => {
                    const videoList = document.getElementById('videoList');
                    if (videoList.lastChild) {
                        videoList.lastChild.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                }, 300);
            }, 100);
        }

        async function searchYouTube() {
            const query = document.getElementById('ytSearchQuery').value.trim();
            if (!query) {
                showNotification('Digite algo para buscar no YouTube', 'error');
                return;
            }

            const resultsContainer = document.getElementById('ytSearchResults');
            resultsContainer.innerHTML = '<div class="loading-yt">Buscando v√≠deos...</div>';

            try {
                // Substitua pela sua chave de API do YouTube
                const API_KEY = 'AIzaSyADkfhlsuGQspanjkzd_2ypc023a5Zl4i0';
                const response = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=5&q=${encodeURIComponent(query)}&key=${API_KEY}&type=video`);

                if (!response.ok) throw new Error('Erro na API do YouTube');

                const data = await response.json();
                const videos = data.items.map(item => ({
                    title: item.snippet.title,
                    url: `https://www.youtube.com/watch?v=${item.id.videoId}`,
                    thumbnail: item.snippet.thumbnails.default.url
                }));

                displayYouTubeResults(videos);
            } catch (error) {
                console.error('Erro na busca do YouTube:', error);
                resultsContainer.innerHTML = '<div class="error-yt">Erro ao buscar v√≠deos. Tente novamente.</div>';
            }
        }

        function displayYouTubeResults(videos) {
            const resultsContainer = document.getElementById('ytSearchResults');
            resultsContainer.innerHTML = '';

            if (videos.length === 0) {
                resultsContainer.innerHTML = '<div class="empty-yt">Nenhum v√≠deo encontrado.</div>';
                return;
            }

            videos.forEach(video => {
                const videoElement = document.createElement('div');
                videoElement.className = 'yt-video-result';
                videoElement.innerHTML = `
            <div class="yt-video-thumbnail">
                <img src="${video.thumbnail}" alt="${video.title}">
            </div>
            <div class="yt-video-info">
                <h4>${video.title}</h4>
                <button class="btn primary small" onclick="selectYouTubeVideo('${video.url}')">
                    <i class="fas fa-plus"></i> Adicionar
                </button>
            </div>
        `;
                resultsContainer.appendChild(videoElement);
            });
        }

        // ====================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCDlr4XHXuwWQ9Zj9dd2yoctLhFz1vbbyM",
            authDomain: "flowlink-7fd57.firebaseapp.com",
            databaseURL: "https://flowlink-7fd57-default-rtdb.firebaseio.com",
            projectId: "flowlink-7fd57",
            storageBucket: "flowlink-7fd57.firebasestorage.app",
            messagingSenderId: "1035085936175",
            appId: "1:1035085936175:web:2732042d77792118b8f8da",
            measurementId: "G-B0NE1GDVQK"
        };

        // Inicializa o Firebase
        firebase.initializeApp(firebaseConfig);

        // Obt√©m uma refer√™ncia para o Realtime Database
        const database = firebase.database();
        const videoQueueRef = database.ref('videoQueue');
        // ====================================================================
        // NOVO: Sistema de Presen√ßa em Tempo Real
        // ====================================================================

        const presenceRef = database.ref('presence');
        const connectedRef = database.ref('.info/connected');
        let myPresenceRef = null; // Guardar√° a nossa pr√≥pria refer√™ncia de conex√£o

        // Monitora o status da conex√£o com o Firebase
        connectedRef.on('value', (snap) => {
            if (snap.val() === true) {
                // Estamos conectados!
                console.log('Firebase conectado. Registrando presen√ßa.');

                // Pega o nome da sess√£o, se j√° existir
                let userName = sessionStorage.getItem('ytSessionUser') || 'Visitante';

                // Cria uma nova entrada √∫nica para este usu√°rio na lista de presen√ßa
                myPresenceRef = presenceRef.push();

                // Define o onDisconnect PRIMEIRO
                // Isso garante que seremos removidos se o navegador fechar
                myPresenceRef.onDisconnect().remove();

                // Agora, define nosso estado online com nosso nome
                myPresenceRef.set({
                    name: userName,
                    joinedAt: firebase.database.ServerValue.TIMESTAMP
                });

            } else {
                // Estamos desconectados (ou nos desconectando)
                // O onDisconnect() do servidor cuidar√° da limpeza.
                console.log('Firebase desconectado.');
            }
        });

        // Agora, vamos ouvir a contagem total de usu√°rios online
        const userCountElement = document.getElementById('userCount');
        presenceRef.on('value', (snap) => {
            // snap.numChildren() conta quantos "filhos" (usu√°rios) existem em /presence
            const count = snap.numChildren();
            if (userCountElement) {
                userCountElement.textContent = count;
            }
        });
        // ====================================================================
        // Fim do Sistema de Presen√ßa
        // ====================================================================

        // ====================================================================
        // NOVO: Fun√ß√µes de Sess√£o de Admin (Login/Logout)
        // ====================================================================

        function openAdminUnlockModal() {
            // Se o admin j√° estiver logado, o bot√£o vira "Logout"
            if (isAdminLoggedIn) {
                logoutAdminSession();
                document.body.classList.add('non-admin');
                disableAdminPlayerControls();

                return; // N√£o abre o modal
            }
            // Se n√£o, abre o modal de login
            document.getElementById('adminUnlockModal').style.display = 'flex';
            document.getElementById('adminUnlockName').focus();
        }

        function closeAdminUnlockModal() {
            document.getElementById('adminUnlockModal').style.display = 'none';
            document.getElementById('adminUnlockName').value = '';
            document.getElementById('adminUnlockPassword').value = '';
        }

        // NOVO: Fecha o modal de confirma√ß√£o de remo√ß√£o em lote
        function closeBulkRemoveConfirmModal() {
            document.getElementById('bulkRemoveConfirmModal').style.display = 'none';
            // Limpa o array de IDs para garantir
            videoIdsForBulkRemove = [];
        }

        async function loginAdminSession() {
            const adminEmail = document.getElementById('adminUnlockName').value.trim();
            const password = document.getElementById('adminUnlockPassword').value;
            document.body.classList.remove('non-admin');

            enableAdminPlayerControls();

            if (!adminEmail || !password) {
                showNotification('Por favor, preencha e-mail e senha.', 'error');
                return;
            }

            toggleLoading('adminUnlockConfirmBtn', true);

            try {
                // Tenta fazer o login no Firebase Auth
                await firebase.auth().signInWithEmailAndPassword(adminEmail, password);

                // SUCESSO!
                isAdminLoggedIn = true; // Define o estado global
                const adminBtn = document.getElementById('adminUnlockBtn');
                adminBtn.classList.add('admin-logged-in'); // Deixa o bot√£o verde
                adminBtn.innerHTML = '<i class="fas fa-unlock"></i> Admin'; // Muda o √≠cone
                document.body.classList.remove('non-admin');
                showNotification('Modo Admin ATIVADO.', 'success');
                closeAdminUnlockModal();

                // *** PARTE 2: Mostra os controles de admin ***
                document.getElementById('videoList').classList.add('admin-mode');
                document.getElementById('bulkRemoveBtn').style.display = 'inline-block';

            } catch (error) {
                console.error('Erro de autentica√ß√£o do admin:', error);
                if (error.code === 'auth/wrong-password') {
                    showNotification('Senha incorreta.', 'error');
                } else if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-email') {
                    showNotification('E-mail n√£o encontrado ou inv√°lido.', 'error');
                } else {
                    showNotification('Erro de autentica√ß√£o.', 'error');
                }
            } finally {
                toggleLoading('adminUnlockConfirmBtn', false);
            }
        }

        function disableAdminPlayerControls() {
            if (!player || typeof YT === 'undefined') return;

            const currentVideoId = player.getVideoData().video_id;
            const currentTime = player.getCurrentTime();

            player.destroy();

            // recria o player bloqueado (sem controles nativos)
            player = new YT.Player('videoPlayer', {
                height: '100%',
                width: '100%',
                videoId: currentVideoId,
                playerVars: {
                    autoplay: 1,
                    controls: 0, // <-- remove os bot√µes nativos
                    modestbranding: 1,
                    rel: 0,
                    disablekb: 1
                },
                events: {
                    onReady: (event) => {
                        event.target.seekTo(currentTime);
                        event.target.playVideo();

                        // mostra a m√°scara novamente
                        document.getElementById('player-mask').style.display = 'block';
                    },
                    onStateChange: onPlayerStateChange
                }
            });
        }


        function enableAdminPlayerControls() {
            if (!player || typeof YT === 'undefined') return;

            const currentVideoId = player.getVideoData().video_id;
            const currentTime = player.getCurrentTime();

            player.destroy(); // remove o player atual

            // recria com controles nativos
            player = new YT.Player('videoPlayer', {
                height: '100%',
                width: '100%',
                videoId: currentVideoId,
                playerVars: {
                    autoplay: 1,
                    controls: 1, // <-- habilita os bot√µes do YouTube
                    modestbranding: 1,
                    rel: 0
                },
                events: {
                    onReady: (event) => {
                        event.target.seekTo(currentTime);
                        event.target.playVideo();
                    },
                    onStateChange: onPlayerStateChange
                }
            });

            function enableAdminPlayerControls() {
                if (!player || typeof YT === 'undefined') return;

                const currentVideoId = player.getVideoData().video_id;
                const currentTime = player.getCurrentTime();

                player.destroy();

                player = new YT.Player('videoPlayer', {
                    height: '100%',
                    width: '100%',
                    videoId: currentVideoId,
                    playerVars: {
                        autoplay: 1,
                        controls: 1,
                        modestbranding: 1,
                        rel: 0
                    },
                    events: {
                        onReady: (event) => {
                            event.target.seekTo(currentTime);
                            event.target.playVideo();

                            // üëá Esconde a m√°scara para liberar cliques
                            document.getElementById('player-mask').style.display = 'none';
                        },
                        onStateChange: onPlayerStateChange
                    }
                });
            }

        }


        function logoutAdminSession() {
            isAdminLoggedIn = false; // Desliga o modo admin
            document.body.classList.add('non-admin');
            const adminBtn = document.getElementById('adminUnlockBtn');
            adminBtn.classList.remove('admin-logged-in'); // Deixa o bot√£o vermelho
            adminBtn.innerHTML = '<i class="fas fa-lock"></i> Admin'; // Muda o √≠cone
            showNotification('Modo Admin DESATIVADO.', 'info');

            // *** PARTE 2: Esconde os controles de admin ***
            document.getElementById('videoList').classList.remove('admin-mode');
            document.getElementById('bulkRemoveBtn').style.display = 'none';
            // Limpa os checkboxes
            document.querySelectorAll('.video-select-checkbox').forEach(cb => cb.checked = false);
        }

        // Adiciona o listener do "olho" da senha para o novo modal
        document.getElementById('toggleAdminUnlockPassword').addEventListener('click', function () {
            const passwordField = document.getElementById('adminUnlockPassword');
            const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordField.setAttribute('type', type);
            this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
        });

        let videoQueue = []; // Array local para espelhar a fila do Firebase
        let player; // Vari√°vel para o player do YouTube
        let videoToRemoveId = null; // ID do v√≠deo a ser removido (usado no modal de remo√ß√£o)
        let isAdminLoggedIn = false; // NOVO: Estado de login do Admin
        let videoIdsForBulkRemove = [];
        /**
         * Exibe uma notifica√ß√£o tempor√°ria na tela.
         * @param {string} message - A mensagem a ser exibida.
         * @param {string} [type='info'] - O tipo da notifica√ß√£o ('info', 'success', 'error').
         */
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationMessage = document.getElementById('notificationMessage');

            notificationMessage.textContent = message;
            notification.className = 'notification';
            notification.classList.add(type, 'show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        /**
         * Alterna o estado de carregamento de um bot√£o (mostra/oculta um spinner).
         * @param {string} buttonId - O ID do bot√£o.
         * @param {boolean} isLoading - True para mostrar o carregamento, false para ocultar.
         */
        function toggleLoading(buttonId, isLoading) {
            const btn = document.getElementById(buttonId);
            const btnText = btn ? btn.querySelector(`#${buttonId.replace('Btn', 'BtnText')}`) : null;
            const btnLoader = btn ? btn.querySelector(`#${buttonId.replace('Btn', 'BtnLoader')}`) : null;

            if (!btn || !btnText || !btnLoader) {
                console.error(`Um ou mais elementos para o bot√£o ${buttonId} n√£o foram encontrados.`);
                return;
            }

            if (isLoading) {
                btn.disabled = true;
                btnText.style.display = 'none';
                btnLoader.style.display = 'inline-block';
            } else {
                btn.disabled = false;
                btnText.style.display = 'inline';
                btnLoader.style.display = 'none';
            }
        }

        /**
         * Adiciona um novo v√≠deo √† fila no Firebase Realtime Database.
         */
        async function addVideo() {
            const phone = document.getElementById('phone').value.trim();
            const videoUrl = document.getElementById('videoUrl').value.trim();

            if (!phone || !videoUrl) {
                showNotification('Por favor, preencha o nome e a URL do v√≠deo.', 'error');
                return;
            }

            const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:m\.)?(?:youtube\.com|youtu\.be)\/(?:watch\?v=|embed\/|v\/|)([\w-]{11})(?:\S+)?/i;
            if (!youtubeRegex.test(videoUrl)) {
                showNotification('Por favor, insira uma URL de v√≠deo v√°lida do YouTube.', 'error');
                return;
            }

            toggleLoading('addVideoBtn', true);

            try {
                const newVideoRef = videoQueueRef.push();
                await newVideoRef.set({
                    id: newVideoRef.key,
                    phone: phone,
                    videoUrl: videoUrl
                });

                showNotification('V√≠deo adicionado com sucesso!', 'success');

                document.getElementById('phone').value = '';
                document.getElementById('videoUrl').value = '';

            } catch (error) {
                console.error('Erro ao adicionar v√≠deo ao Firebase:', error);
                showNotification('Erro ao adicionar o v√≠deo. Verifique a conex√£o com o Firebase.', 'error');
            } finally {
                toggleLoading('addVideoBtn', false);
            }
        }

        /**
         * Carrega a fila de v√≠deos do Firebase Realtime Database e atualiza a UI.
         * Esta fun√ß√£o usa um listener 'value' que √© acionado sempre que os dados na refer√™ncia mudam.
         */
        function loadVideoQueue() {
            videoQueueRef.on('value', async (snapshot) => {
                const data = snapshot.val();
                let fetchedQueue = [];

                if (data) {
                    fetchedQueue = Object.keys(data).map(key => ({
                        id: key,
                        ...data[key]
                    }));
                }

                videoQueue = fetchedQueue;
                const videoList = document.getElementById('videoList');
                videoList.innerHTML = '';
                // NOVO: Aplica a classe de admin se estiver logado
                if (isAdminLoggedIn) {
                    videoList.classList.add('admin-mode');
                } else {
                    videoList.classList.remove('admin-mode');
                }



                if (videoQueue.length === 0) {
                    videoList.innerHTML = '<li class="empty-queue">A fila de v√≠deos est√° vazia. Adicione um v√≠deo!</li>';
                    document.getElementById('currentUser').textContent = 'Nenhum v√≠deo em execu√ß√£o';
                    document.getElementById('currentVideoUrl').textContent = 'Nenhuma URL dispon√≠vel';
                    if (player && typeof player.stopVideo === 'function') {
                        player.stopVideo();
                    }
                    return;
                }

                async function getFormattedVideoTitle(url) {
                    try {
                        // Tenta pegar do cache primeiro
                        const videoId = extractVideoId(url);
                        const cachedTitle = sessionStorage.getItem(`videoTitle_${videoId}`);

                        if (cachedTitle) {
                            return cachedTitle;
                        }

                        // Se n√£o tiver em cache, busca da API do YouTube
                        const API_KEY = 'AIzaSyADkfhlsuGQspanjkzd_2ypc023a5Zl4i0'; // Substitua pela sua chave
                        const response = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${videoId}&key=${API_KEY}`);

                        if (response.ok) {
                            const data = await response.json();
                            if (data.items && data.items[0]) {
                                const title = data.items[0].snippet.title;
                                // Armazena no cache para pr√≥ximas vezes
                                sessionStorage.setItem(`videoTitle_${videoId}`, title);
                                return title;
                            }
                        }
                    } catch (error) {
                        console.error('Erro ao buscar t√≠tulo:', error);
                    }

                    // Fallback: Mostra "M√∫sica (ID do v√≠deo)" se n√£o conseguir o t√≠tulo
                    const videoId = extractVideoId(url);
                    return videoId ? `M√∫sica (ID: ${videoId})` : 'V√≠deo do YouTube';
                }
                // Preenche a lista na UI com t√≠tulos melhorados
                for (const video of videoQueue) {
                    const listItem = document.createElement('li');
                    listItem.classList.add('video-item');

                    // Obt√©m o t√≠tulo formatado
                    const videoTitle = await getFormattedVideoTitle(video.videoUrl);

                    listItem.innerHTML = `
            <div class="bulk-delete-controls">
                <input type="checkbox" class="video-select-checkbox" data-videoid="${video.id}" title="Selecionar para remover">
            </div>

            <div class="video-info">
                <span class="video-title">${videoTitle}</span>
                <div class="video-meta">
                    <span class="video-added-by">Adicionado por: ${video.phone}</span>
                    <a href="${video.videoUrl}" target="_blank" class="video-link">
                        <i class="fab fa-youtube"></i> Assistir
                    </a>
                </div>
            </div>
            <button class="remove-button" onclick="openRemoveModalWithId('${video.id}')" title="Remover v√≠deo">
                <i class="fas fa-times"></i>
            </button>
        `;
                    videoList.appendChild(listItem);
                }

                // Mant√©m a l√≥gica do player
                let currentlyPlayingVideoIdInPlayer = null;
                if (player && typeof player.getVideoData === 'function') {
                    try {
                        currentlyPlayingVideoIdInPlayer = player.getVideoData().video_id;
                    } catch (e) {
                        console.warn("Player.getVideoData() falhou:", e);
                    }
                }

                const firstVideoInQueue = videoQueue[0];
                const firstVideoInQueueId = extractVideoId(firstVideoInQueue.videoUrl);

                if (player && typeof player.loadVideoById === 'function') {
                    const firstVideoInQueue = videoQueue[0];
                    const firstVideoInQueueId = extractVideoId(firstVideoInQueue.videoUrl);

                    // Obter o ID do v√≠deo atualmente carregado no player, se houver
                    let currentlyLoadedVideoId = null;
                    if (player.getVideoData && typeof player.getVideoData === 'function') {
                        try {
                            currentlyLoadedVideoId = player.getVideoData().video_id;
                        } catch (e) {
                            console.warn("Player.getVideoData() falhou ou player n√£o est√° pronto para obter dados do v√≠deo:", e);
                        }
                    }

                    // Apenas carregue um novo v√≠deo se:
                    // 1. N√£o houver nenhum v√≠deo carregado no player (in√≠cio).
                    // 2. O ID do primeiro v√≠deo na fila for diferente do v√≠deo atualmente carregado.
                    // 3. (Opcional, mas recomendado) O player n√£o estiver no estado de "playing" E o v√≠deo que deveria tocar for o primeiro da fila
                    //    Isso serve para garantir que ele reinicie se o v√≠deo atual for o certo, mas ele parou por algum motivo (erro, etc.)
                    if (currentlyLoadedVideoId === null ||
                        currentlyLoadedVideoId !== firstVideoInQueueId ||
                        (player.getPlayerState() !== YT.PlayerState.PLAYING && currentlyLoadedVideoId === firstVideoInQueueId)
                    ) {
                        updateVideoPlayer(firstVideoInQueue.videoUrl, firstVideoInQueue.phone);
                    }
                } else {
                    console.warn('Player do YouTube n√£o est√° pronto para carregar o v√≠deo.');
                }
            });
        }

        /**
         * Extrai o ID do v√≠deo de uma URL do YouTube.
         * @param {string} url - A URL do YouTube.
         * @returns {string|null} O ID do v√≠deo ou null se n√£o for uma URL v√°lida.
         */
        function extractVideoId(url) {
            const regExp = /(?:https?:\/\/)?(?:www\.)?(?:m\.)?(?:youtube\.com|youtu\.be)\/(?:watch\?v=|embed\/|v\/|)([\w-]{11})(?:\S+)?/i;
            const match = url.match(regExp);
            return (match && match[1]) ? match[1] : null;
        }

        /**
         * Obt√©m um t√≠tulo gen√©rico para o v√≠deo com base no ID.
         * @param {string} url - A URL do v√≠deo.
         * @returns {string} O t√≠tulo do v√≠deo.
         */
        function getVideoTitle(url) {
            const videoId = extractVideoId(url);
            return videoId ? `V√≠deo (ID: ${videoId})` : 'V√≠deo do YouTube'; // Ou voc√™ pode usar uma API para obter o t√≠tulo real
        }

        /**
         * Carrega e reproduz um v√≠deo no player do YouTube.
         * @param {string} videoUrl - A URL do v√≠deo a ser carregado.
         * @param {string} userName - O nome do usu√°rio que adicionou o v√≠deo.
         */
        function updateVideoPlayer(videoUrl, userName) {
            const videoId = extractVideoId(videoUrl);

            if (videoId && player && typeof player.loadVideoById === 'function') {
                player.loadVideoById(videoId);
                document.getElementById('currentUser').textContent = userName;
                document.getElementById('currentVideoUrl').textContent = videoUrl;
            } else {
                console.error('URL do YouTube inv√°lida ou player n√£o pronto:', videoUrl);
                document.getElementById('currentUser').textContent = 'Nenhum v√≠deo em execu√ß√£o';
                document.getElementById('currentVideoUrl').textContent = 'Nenhuma URL dispon√≠vel';
                if (player && typeof player.stopVideo === 'function') {
                    player.stopVideo();
                }
            }
        }

        /**
         * Fun√ß√£o chamada quando o estado do player do YouTube muda.
         * Se o v√≠deo terminar, ele remove o v√≠deo atual da fila do Firebase.
         * O listener 'value' do Firebase se encarrega de carregar o pr√≥ximo.
         * @param {Object} event - O objeto de evento do player do YouTube.
         */
        let lastKnownTime = 0;
        let timeCheckInterval;

        function startProgressMonitor() {
            if (timeCheckInterval) {
                clearInterval(timeCheckInterval);
            }

            timeCheckInterval = setInterval(() => {
                if (player && typeof player.getCurrentTime === 'function' && player.getPlayerState() === YT.PlayerState.PLAYING) {
                    const currentTime = player.getCurrentTime();
                    const duration = player.getDuration();

                    const jumpThreshold = 5; // Se avan√ßar mais que 5s
                    const remainingTimeThreshold = 50; // E estiver nos √∫ltimos 5s

                    const jumped = currentTime > lastKnownTime + jumpThreshold;
                    const nearEnd = currentTime >= duration - remainingTimeThreshold && currentTime < duration;

                    if (jumped && !nearEnd) {
                        console.log('Detectado adiantamento no v√≠deo.');
                    } else if (jumped && nearEnd) {
                        // ‚Üê ADIANTAMENTO PARA PERTO DO FINAL DETECTADO
                        console.log('Detectado adiantamento para o final do v√≠deo.');

                        player.pauseVideo();
                        player.seekTo(lastKnownTime + 1, true);
                        showNotification('Voc√™ n√£o pode adiantar o v√≠deo at√© o final.', 'error');

                        return; // ‚Üê N√ÉO ATUALIZA lastKnownTime!
                    }

                    // S√≥ atualiza se n√£o houver adiantamento suspeito
                    lastKnownTime = currentTime;
                }
            }, 1000);
        }


        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.ENDED) {
                const currentTime = player.getCurrentTime();
                const duration = player.getDuration();
                // Definimos uma toler√¢ncia. Se o v√≠deo terminou dentro, digamos,
                // dos √∫ltimos 1.5 segundos da dura√ß√£o total, consideramos que foi um fim natural.
                const naturalEndTolerance = 0.5; // Se voc√™ quer que o v√≠deo s√≥ pule se realmente chegar ao fim exato // Ajuste este valor se necess√°rio (0.5 a 2 segundos √© um bom ponto de partida)

                // Se o tempo atual estiver muito pr√≥ximo da dura√ß√£o total, consideramos um fim natural.
                if (duration - currentTime <= naturalEndTolerance) {
                    console.log('V√≠deo terminou naturalmente. Avan√ßando para o pr√≥ximo...');
                    // L√≥gica para avan√ßo autom√°tico (fim natural)
                    if (videoQueue.length > 0) {
                        const firstVideoInQueue = videoQueue[0];
                        const currentPlayingVideoIdInPlayer = player.getVideoData().video_id;
                        const expectedVideoIdInQueue = extractVideoId(firstVideoInQueue.videoUrl);

                        // Garante que o v√≠deo que terminou √© o primeiro da fila antes de remover
                        if (currentPlayingVideoIdInPlayer === expectedVideoIdInQueue) {
                            videoQueueRef.child(firstVideoInQueue.id).remove()
                                .then(() => {
                                    console.log('V√≠deo atual removido da fila automaticamente (fim natural).');
                                    // O listener do Firebase (loadVideoQueue) cuidar√° de carregar o pr√≥ximo
                                })
                                .catch(error => {
                                    console.error('Erro ao remover v√≠deo automaticamente do Firebase:', error);
                                    showNotification('Erro ao avan√ßar o v√≠deo automaticamente. Tente novamente.', 'error');
                                });
                        } else {
                            console.warn('O v√≠deo que terminou n√£o √© o primeiro da fila esperada. Nenhuma remo√ß√£o autom√°tica.');
                        }
                    } else {
                        console.log('Fila vazia, n√£o h√° v√≠deos para remover automaticamente.');
                        // Opcional: Pare o player se a fila estiver vazia
                        if (player && typeof player.stopVideo === 'function') {
                            player.stopVideo();
                        }
                    }
                } else {
                    // Este bloco ser√° executado se o v√≠deo atingiu o estado ENDED,
                    // mas o tempo atual estava significativamente longe do final (ou seja, foi adiantado).
                    console.log('V√≠deo foi adiantado/pulado para o fim. N√ÉO avan√ßando automaticamente. Tempo atual:', currentTime, 'Dura√ß√£o:', duration);
                    showNotification('O v√≠deo atual foi adiantado. Por favor, use o bot√£o "Pr√≥ximo V√≠deo" e as credenciais de administrador para avan√ßar a fila.', 'info');

                    // √â uma boa pr√°tica parar o player para que ele n√£o tente reiniciar ou loop se autoplay estiver ativado
                    if (player && typeof player.stopVideo === 'function') {
                        player.stopVideo();
                    }
                }
            }
        }


        // Vari√°vel para armazenar o ID do v√≠deo a ser removido (o que acabou de tocar)
        // (Mantenha esta vari√°vel no escopo global ou onde 'videoToRemoveId' est√°)

        /**
                 * Fun√ß√£o "port√£o" para pular o v√≠deo.
                 * Verifica se o admin est√° logado. Se sim, pula direto.
                 * Se n√£o, abre o modal de autentica√ß√£o.
                 */
        function handleSkipVideo() {
            // Verifica se a fila est√° vazia
            if (videoQueue.length === 0) {
                showNotification('A fila est√° vazia. N√£o h√° pr√≥ximo v√≠deo para avan√ßar.', 'info');
                return;
            }

            if (isAdminLoggedIn) {
                // Admin est√° logado: executa a l√≥gica de pular diretamente
                console.log('Admin logado. Pulando v√≠deo...');
                executeSkipVideo(); // N√£o precisa de 'await'
            } else {
                // Admin n√£o est√° logado: abre o modal para pedir credenciais
                console.log('Admin n√£o logado. Abrindo modal de autentica√ß√£o...');
                openNextVideoModal();
            }
        }

        /**
         * Abre o modal para avan√ßar para o pr√≥ximo v√≠deo, pedindo credenciais do admin.
         */
        function openNextVideoModal() {
            // Se a fila estiver vazia, n√£o h√° pr√≥ximo v√≠deo para avan√ßar
            if (videoQueue.length === 0) {
                showNotification('A fila est√° vazia. N√£o h√° pr√≥ximo v√≠deo para avan√ßar.', 'info');
                return;
            }

            // O ID do v√≠deo que est√° atualmente em execu√ß√£o (o primeiro da fila)
            // ser√° o que ser√° removido quando o admin confirmar.


            document.getElementById('nextVideoModal').style.display = 'flex';
            document.getElementById('nextAdminName').focus(); // Foca no campo de nome
        }

        /**
         * Fecha o modal de "Pr√≥ximo V√≠deo" e limpa os campos.
         */
        function closeNextVideoModal() {
            document.getElementById('nextVideoModal').style.display = 'none';
            document.getElementById('nextAdminName').value = '';
            document.getElementById('nextPassword').value = '';

        }

        /**
         * Fun√ß√£o para avan√ßar para o pr√≥ximo v√≠deo na fila, ap√≥s autentica√ß√£o do admin.
         */
        async function playNextVideo() {
            const adminEmail = document.getElementById('nextAdminName').value.trim();
            const password = document.getElementById('nextPassword').value;

            if (!adminEmail || !password) {
                showNotification('Por favor, preencha o nome e a senha de administrador.', 'error');
                return;
            }

            // A verifica√ß√£o da fila ser√° feita pela executeSkipVideo, 
            // mas √© bom ter aqui para fechar o modal se a fila esvaziou.
            if (videoQueue.length === 0) {
                showNotification('A fila est√° vazia. N√£o h√° pr√≥ximo v√≠deo para avan√ßar.', 'info');
                closeNextVideoModal();
                return;
            }

            toggleLoading('playNextVideoBtn', true);

            try {
                // 1. Tenta autenticar
                await firebase.auth().signInWithEmailAndPassword(adminEmail, password);

                // 2. Se autenticou, executa a l√≥gica de pular
                const success = await executeSkipVideo();

                // 3. Se a l√≥gica de pular foi bem-sucedida, fecha o modal
                if (success) {
                    closeNextVideoModal();
                }

            } catch (error) {
                console.error('Erro de autentica√ß√£o ou ao avan√ßar v√≠deo:', error);

                if (error.code === 'auth/wrong-password') {
                    showNotification('Senha incorreta. Por favor, tente novamente.', 'error');
                } else if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-email') {
                    showNotification('E-mail n√£o encontrado ou inv√°lido. Tente novamente.', 'error');
                } else {
                    // Erro gen√©rico de autentica√ß√£o
                    showNotification('Erro de autentica√ß√£o.', 'error');
                }
            } finally {
                toggleLoading('playNextVideoBtn', false);
            }
        }

        // Event listener para alternar a visibilidade da senha no modal "Pr√≥ximo V√≠deo"
        document.getElementById('toggleNextPassword').addEventListener('click', function () {
            const passwordField = document.getElementById('nextPassword');
            const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordField.setAttribute('type', type);
            this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
        });

        /**
         * L√≥gica central para avan√ßar o v√≠deo.
         * Remove o primeiro v√≠deo da fila.
         * @returns {Promise<boolean>} - Retorna 'true' se foi bem-sucedido, 'false' se falhou.
         */
        async function executeSkipVideo() {
            if (videoQueue.length === 0) {
                showNotification('A fila est√° vazia. N√£o h√° pr√≥ximo v√≠deo para avan√ßar.', 'info');
                return false; // Retorna 'false' para indicar falha
            }

            try {
                // O ID do v√≠deo a ser removido √© sempre o primeiro na fila
                const idToRemove = videoQueue[0].id;
                await videoQueueRef.child(idToRemove).remove();

                showNotification('Avan√ßando para o pr√≥ximo v√≠deo!', 'success');
                return true; // Retorna 'true' para indicar sucesso
            } catch (error) {
                console.error('Erro ao avan√ßar v√≠deo:', error);
                showNotification('Erro ao avan√ßar o v√≠deo. Verifique a conex√£o.', 'error');
                return false; // Retorna 'false' para indicar falha
            }
        }

        // ====================================================================
        // NOVO: Fun√ß√£o de Remo√ß√£o em Lote
        // ====================================================================
        // Esta fun√ß√£o agora APENAS abre o modal de confirma√ß√£o
        function removeSelectedVideos() {
            // Apenas admins logados podem usar
            if (!isAdminLoggedIn) {
                showNotification('Voc√™ precisa estar no Modo Admin para fazer isso.', 'error');
                return;
            }

            // 1. Encontra todos os checkboxes marcados
            const selectedCheckboxes = document.querySelectorAll('.video-select-checkbox:checked');

            if (selectedCheckboxes.length === 0) {
                showNotification('Nenhum v√≠deo selecionado para remo√ß√£o.', 'info');
                return;
            }

            // 2. Pega os IDs de cada um e salva na vari√°vel global
            // (Substitui a const videoIdsToRemove)
            videoIdsForBulkRemove = Array.from(selectedCheckboxes).map(cb => cb.dataset.videoid);

            // 3. Prepara e abre o modal de confirma√ß√£o (Substitui o 'confirm()')
            // (Isto assume que seu modal tem um <p> com id="bulkRemoveMessage")
            document.getElementById('bulkRemoveMessage').textContent = `Tem certeza que deseja remover ${videoIdsForBulkRemove.length} v√≠deos da fila? Esta a√ß√£o n√£o pode ser desfeita.`;

            // (Isto assume que seu modal de confirma√ß√£o tem id="bulkRemoveConfirmModal")
            document.getElementById('bulkRemoveConfirmModal').style.display = 'flex';
        }

        // NOVO: Esta fun√ß√£o √© chamada pelo modal para EXECUTAR a remo√ß√£o
        async function executeBulkRemove() {
            // 1. Pega os IDs da vari√°vel global
            if (videoIdsForBulkRemove.length === 0) {
                showNotification('Erro: Nenhum v√≠deo selecionado.', 'error');
                closeBulkRemoveConfirmModal();
                return;
            }

            toggleLoading('bulkRemoveConfirmBtn', true); // Ativa o loading

            // 2. Cria um array de "promessas" de remo√ß√£o
            let removePromises = [];
            videoIdsForBulkRemove.forEach(id => {
                removePromises.push(videoQueueRef.child(id).remove());
            });

            // 3. Executa todas as remo√ß√µes em paralelo
            try {
                await Promise.all(removePromises);
                showNotification(`${videoIdsForBulkRemove.length} v√≠deos removidos com sucesso.`, 'success');
            } catch (error) {
                console.error("Erro ao remover v√≠deos em lote:", error);
                showNotification('Ocorreu um erro ao remover os v√≠deos.', 'error');
            } finally {
                toggleLoading('bulkRemoveConfirmBtn', false); // Desativa o loading
                closeBulkRemoveConfirmModal(); // Fecha o modal e limpa o array
            }
        }


        /**
         * Fun√ß√£o chamada quando a API do YouTube Iframe est√° pronta.
    // ... (o resto da sua fun√ß√£o onYouTubeIframeAPIReady come√ßa aqui)
        /**
         * Fun√ß√£o chamada quando a API do YouTube Iframe est√° pronta.
         * Inicializa o player e carrega a fila de v√≠deos.
         */
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('videoPlayer', {
                height: '100%',
                width: '100%',
                playerVars: {
                    'autoplay': 1,
                    'controls': 0,        // <- esconder controles nativos
                    'modestbranding': 1,
                    'rel': 0,
                    'disablekb': 1        // desativa teclas de atalho para evitar seek via teclado
                },
                events: {
                    'onReady': (event) => {
                        // define volume inicial e carrega fila
                        player.setVolume(50);
                        loadVideoQueue();
                    },
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        // ======== Controles do overlay ========
        const overlayPlayBtn = document.getElementById('overlayPlayBtn');
        const overlayPlayIcon = document.getElementById('overlayPlayIcon');
        const overlayVolume = document.getElementById('overlayVolume');
        

        const overlayFullscreenBtn = document.getElementById('overlayFullscreenBtn');

        
overlayFullscreenBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    toggleFullscreen();
});

function toggleFullscreen() {
    const container = document.getElementById('player-container');
    if (!document.fullscreenElement) {
        if (container.requestFullscreen) {
            container.requestFullscreen();
        } else if (container.webkitRequestFullscreen) {
            container.webkitRequestFullscreen();
        } else if (container.msRequestFullscreen) {
            container.msRequestFullscreen();
        }
    } else {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
        }
    }
    
}

        function updateOverlayPlayIcon() {
            if (!player || typeof player.getPlayerState !== 'function') return;
            const state = player.getPlayerState();
            if (state === YT.PlayerState.PLAYING) {
                overlayPlayIcon.className = 'fas fa-pause';
            } else {
                overlayPlayIcon.className = 'fas fa-play';
            }
        }

        function togglePlayPauseFromOverlay() {
            if (!player) return;
            const state = player.getPlayerState();
            if (state === YT.PlayerState.PLAYING) {
                player.pauseVideo();
            } else {
                player.playVideo();
            }
            setTimeout(updateOverlayPlayIcon, 100); // atualiza √≠cone logo depois
        }

        function setVolumeFromOverlay(value) {
            if (!player || typeof player.setVolume !== 'function') return;
            player.setVolume(Number(value));
            showNotification(`Volume: ${value}%`, 'info');
        }

        // listeners
        overlayPlayBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            togglePlayPauseFromOverlay();
        });

        overlayVolume.addEventListener('input', (e) => {
            e.stopPropagation();
            setVolumeFromOverlay(e.target.value);
        });

        // Tamb√©m atualiza √≠cone quando o estado do player muda pela API (ex.: autoplay)
        function onPlayerStateChange(event) {
            // chama seu c√≥digo existente para ended, etc.
            // === mantenha o bloco que voc√™ j√° tinha para YT.PlayerState.ENDED ===
            // ... (seu c√≥digo anterior de onPlayerStateChange permanece)
            // depois, atualize √≠cone do overlay
            setTimeout(updateOverlayPlayIcon, 50);
        }

        function handleClearQueue() {
            if (isAdminLoggedIn) {
                // Admin est√° logado: executa a l√≥gica de limpar diretamente
                console.log('Admin logado. Limpando fila...');
                executeClearQueue(); // N√£o precisa de 'await'
            } else {
                // Admin n√£o est√° logado: abre o modal para pedir credenciais
                console.log('Admin n√£o logado. Abrindo modal de autentica√ß√£o...');
                openModal();
            }
        }

        /**
         * Abre o modal para limpar a fila.
         */
        function openModal() {
            document.getElementById('modal').style.display = 'flex';
            document.getElementById('adminName').focus();
        }

        /**
         * Fecha o modal para limpar a fila e limpa os campos.
         */
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            document.getElementById('adminName').value = '';
            document.getElementById('clearPassword').value = '';
        }

        /**
         * Abre o modal para remover um v√≠deo espec√≠fico.
         * @param {string} id - O ID (chave do Firebase) do v√≠deo a ser removido.
         */
        function openRemoveModalWithId(id) {
            videoToRemoveId = id; // Armazena o ID do Firebase key, que √© uma string
            document.getElementById('removeModal').style.display = 'flex';
            document.getElementById('removeAdminName').focus();
        }

        /**
         * Fecha o modal para remover um v√≠deo e limpa os campos.
         */
        function closeRemoveModal() {
            document.getElementById('removeModal').style.display = 'none';
            document.getElementById('removeAdminName').value = '';
            document.getElementById('removePassword').value = '';
            videoToRemoveId = null; // Reseta o ID do v√≠deo a ser removido
        }

        /**
          * L√≥gica central para limpar a fila (sem autentica√ß√£o).
          * Remove todos os v√≠deos da fila.
          * @returns {Promise<boolean>} - Retorna 'true' se foi bem-sucedido, 'false' se falhou.
          */
        async function executeClearQueue() {
            try {
                await videoQueueRef.remove();
                showNotification('Fila limpa com sucesso!', 'success');
                return true;
            } catch (error) {
                console.error('Erro ao limpar fila:', error);
                showNotification('Erro ao limpar a fila. Verifique a conex√£o.', 'error');
                return false;
            }
        }

        /**
         * Limpa toda a fila de v√≠deos no Firebase Realtime Database.
         * Requer credenciais de administrador (chamado pelo modal).
         */
        async function clearQueue() {
            const adminEmail = document.getElementById('adminName').value.trim();
            const password = document.getElementById('clearPassword').value;

            if (!adminEmail || !password) {
                showNotification('Por favor, preencha todos os campos.', 'error');
                return;
            }

            toggleLoading('clearQueueBtn', true);

            try {
                // 1. Tenta autenticar
                await firebase.auth().signInWithEmailAndPassword(adminEmail, password);

                // 2. Se autenticou, executa a l√≥gica de limpar
                const success = await executeClearQueue();

                // 3. Se foi bem-sucedido, fecha o modal
                if (success) {
                    closeModal();
                }

            } catch (error) {
                console.error('Erro de autentica√ß√£o ou ao limpar fila:', error);
                if (error.code === 'auth/wrong-password') {
                    showNotification('Senha incorreta. Por favor, tente novamente.', 'error');
                } else if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-email') {
                    showNotification('E-mail n√£o encontrado ou inv√°lido. Tente novamente.', 'error');
                } else {
                    showNotification('Erro ao limpar a fila. Verifique a conex√£o.', 'error');
                }
            } finally {
                toggleLoading('clearQueueBtn', false);
            }
        }

        /**
         * Remove um v√≠deo espec√≠fico da fila no Firebase Realtime Database.
         * Requer credenciais de administrador.
         */
        async function removeVideo() {
            const adminEmail = document.getElementById('removeAdminName').value.trim();
            const password = document.getElementById('removePassword').value;

            if (!adminEmail || !password) {
                showNotification('Por favor, preencha todos os campos.', 'error');
                return;
            }

            if (videoToRemoveId === null) {
                showNotification('Nenhum v√≠deo selecionado para remo√ß√£o.', 'error');
                return;
            }

            toggleLoading('removeVideoBtn', true);

            try {
                await firebase.auth().signInWithEmailAndPassword(adminEmail, password);
                await videoQueueRef.child(videoToRemoveId).remove();
                showNotification('V√≠deo removido com sucesso!', 'success');
                closeRemoveModal();
            } catch (error) {
                console.error('Erro de autentica√ß√£o ou ao remover v√≠deo:', error);
                if (error.code === 'auth/wrong-password') {
                    showNotification('Senha incorreta. Por favor, tente novamente.', 'error');
                } else if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-email') {
                    showNotification('E-mail n√£o encontrado ou inv√°lido. Tente novamente.', 'error');
                } else {
                    showNotification('Erro ao remover o v√≠deo. Verifique a conex√£o.', 'error');
                }
            } finally {
                toggleLoading('removeVideoBtn', false);
            }
        }

        // Event listeners para alternar a visibilidade da senha nos modais
        document.getElementById('togglePassword').addEventListener('click', function () {
            const passwordField = document.getElementById('clearPassword');
            const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordField.setAttribute('type', type);
            this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
        });

        document.getElementById('toggleRemovePassword').addEventListener('click', function () {
            const passwordField = document.getElementById('removePassword');
            const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordField.setAttribute('type', type);
            this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
        });

        // Fecha os modais se o usu√°rio clicar fora do conte√∫do do modal
        window.addEventListener('click', function (event) {
            if (event.target.classList.contains('modal')) {
                closeModal();
                closeRemoveModal();
                closeYTSearchModal();
                closeNextVideoModal();
                closeAdminUnlockModal();
                closeBulkRemoveConfirmModal();
            }
        });

        // Fecha os modais se o usu√°rio pressionar a tecla 'Escape'
        document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') {
                closeModal();
                closeRemoveModal();
                closeYTSearchModal();
                closeNextVideoModal();
                closeAdminUnlockModal();
                closeBulkRemoveConfirmModal();
            }
        });

        // Efeito de fade-in na carga da p√°gina
        document.addEventListener('DOMContentLoaded', function () {
            document.body.style.opacity = '0';
            setTimeout(() => {
                document.body.style.transition = 'opacity 0.5s ease';
                document.body.style.opacity = '1';
            }, 100);
        });
    </script>
</body>

</html>