<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowLink</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.youtube.com/iframe_api"></script> 

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header class="app-header">
            <h1><i class="fas fa-music"></i> FlowLink<i class="fas fa-headphones"></i></h1>
        </header>

        <main class="main-layout">
            <section class="input-section card">
                <h2><i class="fas fa-plus-circle"></i> Adicionar Vídeo</h2>
                <div class="input-group">
                    <label for="phone"><i class="fas fa-user"></i> Nome:</label>
                    <input type="text" id="phone" placeholder="Quem adicionou?" required>
                </div>
                <div class="input-group">
                    <label for="videoUrl"><i class="fab fa-youtube"></i> URL do Vídeo:</label>
                    <input type="text" id="videoUrl" placeholder="Link do YouTube" required>
                </div>
                <button class="btn primary" onclick="addVideo()" id="addVideoBtn">
                    <span id="addBtnText">Adicionar à Fila</span>
                    <span id="addBtnLoader" class="loading" style="display: none;"></span>
                </button>
                <button class="btn secondary" onclick="openYTSearchModal()">
        <i class="fab fa-youtube"></i> Buscar no YouTube
    </button>
            </section>

            <section class="video-player-section card">
                <h2><i class="fas fa-play-circle"></i> Vídeo em Execução</h2>
                <div id="player-container">
                    <div id="videoPlayer"></div>
                </div>
                <div id="currentVideoInfo">
                    <h3>Escolha de: <span id="currentUser">Nenhum vídeo em execução</span></h3>
                    <p class="current-url" id="currentVideoUrl">Nenhuma URL disponível</p>
                </div>
            </section>

            <section class="queue-section card">
                <h2>
                    <i class="fas fa-list-ol"></i> Fila de Música
                    <button class="btn danger clear-queue-button" onclick="openModal()">
                        <i class="fas fa-trash-alt"></i> Limpar Fila
                    </button>
                </h2>
                <ul id="videoList" class="video-queue-list"></ul>
            </section>
        </main>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">×</span>
            <h3><i class="fas fa-trash-alt"></i> Limpar Fila</h3>
            <p>Digite seu nome e a senha para limpar a fila.</p>
            <div class="input-group">
                <label for="adminName"><i class="fas fa-user-shield"></i> Nome do Admin:</label>
                <input type="text" id="adminName" placeholder="Seu nome" required>
            </div>
            <div class="input-group password-group">
                <label for="clearPassword"><i class="fas fa-lock"></i> Senha:</label>
                <input type="password" id="clearPassword" placeholder="Senha de administrador" required>
                <span class="toggle-password" id="togglePassword"><i class="fas fa-eye"></i></span>
            </div>
            <button class="btn primary" onclick="clearQueue()" id="clearQueueBtn">
                <span id="clearBtnText">Confirmar Limpeza</span>
                <span id="clearBtnLoader" class="loading" style="display: none;"></span>
            </button>
        </div>
    </div>

    <div id="removeModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeRemoveModal()">×</span>
            <h3><i class="fas fa-trash"></i> Remover Vídeo</h3>
            <p>Digite seu nome e a senha para remover o vídeo selecionado.</p>
            <div class="input-group">
                <label for="removeAdminName"><i class="fas fa-user-shield"></i> Nome do Admin:</label>
                <input type="text" id="removeAdminName" placeholder="Seu nome" required>
            </div>
            <div class="input-group password-group">
                <label for="removePassword"><i class="fas fa-lock"></i> Senha:</label>
                <input type="password" id="removePassword" placeholder="Senha de administrador" required>
                <span class="toggle-password" id="toggleRemovePassword"><i class="fas fa-eye"></i></span>
            </div>
            <button class="btn primary" onclick="removeVideo()" id="removeVideoBtn">
                <span id="removeBtnText">Confirmar Remoção</span>
                <span id="removeBtnLoader" class="loading" style="display: none;"></span>
            </button>
        </div>
    </div>

    <div id="ytSearchModal" class="modal">
    <div class="modal-content yt-search-modal">
        <span class="close-button" onclick="closeYTSearchModal()">×</span>
        <h3><i class="fab fa-youtube"></i> Buscar Vídeo no YouTube</h3>
        <div class="input-group">
            <input type="text" id="ytSearchQuery" placeholder="Digite sua busca">
            <button class="btn primary" onclick="searchYouTube()">
                <i class="fas fa-search"></i> Buscar
            </button>
        </div>
        <div id="ytSearchResults" class="yt-search-results"></div>
    </div>
</div>

    <div id="notification" class="notification">
        <span id="notificationMessage"></span>
    </div>

    <script>

        // ====================================================================
       // Funções para o modal de busca no YouTube
function openYTSearchModal() {
    document.getElementById('ytSearchModal').style.display = 'flex';
    document.getElementById('ytSearchQuery').focus();
}

function closeYTSearchModal() {
    document.getElementById('ytSearchModal').style.display = 'none';
    document.getElementById('ytSearchQuery').value = '';
    document.getElementById('ytSearchResults').innerHTML = '';
}

function selectYouTubeVideo(videoUrl, videoTitle) {
    // Preenche os campos
    document.getElementById('videoUrl').value = videoUrl;
    // Usa o título do vídeo como nome (ou pode pedir para o usuário preencher)
    document.getElementById('phone').value = videoTitle || "Usuário YouTube";
    
    // Fecha o modal
    closeYTSearchModal();
    
    // Aguarda um breve momento para garantir que os campos estão atualizados
    setTimeout(() => {
        addVideo();
    }, 100);
}

async function searchYouTube() {
    const query = document.getElementById('ytSearchQuery').value.trim();
    if (!query) {
        showNotification('Digite algo para buscar no YouTube', 'error');
        return;
    }

    const resultsContainer = document.getElementById('ytSearchResults');
    resultsContainer.innerHTML = '<div class="loading-yt">Buscando vídeos...</div>';

    try {
        // Substitua pela sua chave de API do YouTube
        const API_KEY = 'AIzaSyADkfhlsuGQspanjkzd_2ypc023a5Zl4i0';
        const response = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=5&q=${encodeURIComponent(query)}&key=${API_KEY}&type=video`);
        
        if (!response.ok) throw new Error('Erro na API do YouTube');
        
        const data = await response.json();
        const videos = data.items.map(item => ({
            title: item.snippet.title,
            url: `https://www.youtube.com/watch?v=${item.id.videoId}`,
            thumbnail: item.snippet.thumbnails.default.url
        }));
        
        displayYouTubeResults(videos);
    } catch (error) {
        console.error('Erro na busca do YouTube:', error);
        resultsContainer.innerHTML = '<div class="error-yt">Erro ao buscar vídeos. Tente novamente.</div>';
    }
}

function displayYouTubeResults(videos) {
    const resultsContainer = document.getElementById('ytSearchResults');
    resultsContainer.innerHTML = '';

    if (videos.length === 0) {
        resultsContainer.innerHTML = '<div class="empty-yt">Nenhum vídeo encontrado.</div>';
        return;
    }

    videos.forEach(video => {
        const videoElement = document.createElement('div');
        videoElement.className = 'yt-video-result';
        videoElement.innerHTML = `
            <div class="yt-video-thumbnail">
                <img src="${video.thumbnail}" alt="${video.title}">
            </div>
            <div class="yt-video-info">
                <h4>${video.title}</h4>
                <button class="btn primary small" onclick="selectYouTubeVideo('${video.url}')">
                    <i class="fas fa-plus"></i> Adicionar
                </button>
            </div>
        `;
        resultsContainer.appendChild(videoElement);
    });
}

        // ====================================================================
        const firebaseConfig = {
            apiKey: "AIzasyCDlR4XhuwMQ9ZJ9dd2yoctLHfz1vbbYM",
            authDomain: "flowlink-7fd57.firebaseapp.com",
            projectId: "flowlink-7fd57",
            storageBucket: "flowlink-7fd57.appspot.com",
            messagingSenderId: "1035085936175",
            appId: "1:1035085936175:web:2732042d77792118b8f8da",
            measurementId: "G-8ONE1GDVQK"
        };

        // Inicializa o Firebase
        firebase.initializeApp(firebaseConfig);

        // Obtém uma referência para o Realtime Database
        const database = firebase.database();
        const videoQueueRef = database.ref('videoQueue');

        let videoQueue = []; // Array local para espelhar a fila do Firebase
        let player; // Variável para o player do YouTube
        let videoToRemoveId = null; // ID do vídeo a ser removido (usado no modal de remoção)

        /**
         * Exibe uma notificação temporária na tela.
         * @param {string} message - A mensagem a ser exibida.
         * @param {string} [type='info'] - O tipo da notificação ('info', 'success', 'error').
         */
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationMessage = document.getElementById('notificationMessage');
            
            notificationMessage.textContent = message;
            notification.className = 'notification'; 
            notification.classList.add(type, 'show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        /**
         * Alterna o estado de carregamento de um botão (mostra/oculta um spinner).
         * @param {string} buttonId - O ID do botão.
         * @param {boolean} isLoading - True para mostrar o carregamento, false para ocultar.
         */
        function toggleLoading(buttonId, isLoading) {
            const btn = document.getElementById(buttonId);
            const btnText = btn ? btn.querySelector(`#${buttonId.replace('Btn', 'BtnText')}`) : null;
            const btnLoader = btn ? btn.querySelector(`#${buttonId.replace('Btn', 'BtnLoader')}`) : null;
            
            if (!btn || !btnText || !btnLoader) {
                console.error(`Um ou mais elementos para o botão ${buttonId} não foram encontrados.`);
                return;
            }

            if (isLoading) {
                btn.disabled = true;
                btnText.style.display = 'none';
                btnLoader.style.display = 'inline-block';
            } else {
                btn.disabled = false;
                btnText.style.display = 'inline';
                btnLoader.style.display = 'none';
            }
        }

        /**
         * Adiciona um novo vídeo à fila no Firebase Realtime Database.
         */
        async function addVideo() {
            const phone = document.getElementById('phone').value.trim();
            const videoUrl = document.getElementById('videoUrl').value.trim();

            if (!phone || !videoUrl) {
                showNotification('Por favor, preencha o nome e a URL do vídeo.', 'error');
                return;
            }

            const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:m\.)?(?:youtube\.com|youtu\.be)\/(?:watch\?v=|embed\/|v\/|)([\w-]{11})(?:\S+)?/i;
            if (!youtubeRegex.test(videoUrl)) {
                showNotification('Por favor, insira uma URL de vídeo válida do YouTube.', 'error');
                return;
            }

            toggleLoading('addVideoBtn', true);

            try {
                const newVideoRef = videoQueueRef.push();
                await newVideoRef.set({
                    id: newVideoRef.key, 
                    phone: phone,
                    videoUrl: videoUrl
                });

                showNotification('Vídeo adicionado com sucesso!', 'success');
                
                document.getElementById('phone').value = '';
                document.getElementById('videoUrl').value = '';

            } catch (error) {
                console.error('Erro ao adicionar vídeo ao Firebase:', error);
                showNotification('Erro ao adicionar o vídeo. Verifique a conexão com o Firebase.', 'error');
            } finally {
                toggleLoading('addVideoBtn', false);
            }
        }

        /**
         * Carrega a fila de vídeos do Firebase Realtime Database e atualiza a UI.
         * Esta função usa um listener 'value' que é acionado sempre que os dados na referência mudam.
         */
        function loadVideoQueue() {
            videoQueueRef.on('value', (snapshot) => {
                const data = snapshot.val();
                let fetchedQueue = [];

                if (data) {
                    fetchedQueue = Object.keys(data).map(key => ({
                        id: key,
                        ...data[key]
                    }));
                    // Opcional: Para garantir a ordem, você pode querer ordenar por alguma propriedade como timestamp, se você a adicionasse.
                    // Ex: videoQueueRef.push().set({ ..., timestamp: firebase.database.ServerValue.TIMESTAMP });
                    // fetchedQueue.sort((a, b) => a.timestamp - b.timestamp);
                }
                
                videoQueue = fetchedQueue; // Atualiza a fila local

                const videoList = document.getElementById('videoList');
                videoList.innerHTML = ''; 

                if (videoQueue.length === 0) {
                    videoList.innerHTML = '<li class="empty-queue">A fila de vídeos está vazia. Adicione um vídeo!</li>';
                    document.getElementById('currentUser').textContent = 'Nenhum vídeo em execução';
                    document.getElementById('currentVideoUrl').textContent = 'Nenhuma URL disponível';
                    if (player && typeof player.stopVideo === 'function') {
                        player.stopVideo();
                    }
                    return;
                }

                // Preenche a lista na UI
                videoQueue.forEach((video) => {
                    const listItem = document.createElement('li');
                    listItem.classList.add('video-item');
                    // CORREÇÃO: Template literals para exibir corretamente nome e URL/título
                    listItem.innerHTML = `
                        <span><strong>${video.phone}:</strong> <a href="${video.videoUrl}" target="_blank">${getVideoTitle(video.videoUrl)}</a></span>
                        <button class="remove-button" onclick="openRemoveModalWithId('${video.id}')" title="Remover vídeo">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    videoList.appendChild(listItem);
                });

                // Lógica para controlar o player do YouTube com base na fila:
                let currentlyPlayingVideoIdInPlayer = null;
                if (player && typeof player.getVideoData === 'function') {
                    try {
                        currentlyPlayingVideoIdInPlayer = player.getVideoData().video_id;
                    } catch (e) {
                        // Ocorre se o player não está totalmente pronto ou não há vídeo carregado
                        // console.warn("Player.getVideoData() falhou ou player não está pronto.", e);
                    }
                }

                const firstVideoInQueue = videoQueue[0];
                const firstVideoInQueueId = extractVideoId(firstVideoInQueue.videoUrl);

                // Regra para carregar/iniciar o vídeo:
                // 1. Se o player está pronto.
                // 2. Se o ID do vídeo no player é diferente do primeiro na fila.
                // 3. Se o player não está tocando.
                if (player && typeof player.loadVideoById === 'function') {
                    if (currentlyPlayingVideoIdInPlayer !== firstVideoInQueueId || player.getPlayerState() !== YT.PlayerState.PLAYING) {
                        updateVideoPlayer(firstVideoInQueue.videoUrl, firstVideoInQueue.phone);
                    }
                } else {
                    // Caso o player ainda não esteja inicializado ou não seja uma função
                    console.warn('Player do YouTube não está pronto para carregar o vídeo.');
                }
            });
        }

        /**
         * Extrai o ID do vídeo de uma URL do YouTube.
         * @param {string} url - A URL do YouTube.
         * @returns {string|null} O ID do vídeo ou null se não for uma URL válida.
         */
        function extractVideoId(url) {
            const regExp = /(?:https?:\/\/)?(?:www\.)?(?:m\.)?(?:youtube\.com|youtu\.be)\/(?:watch\?v=|embed\/|v\/|)([\w-]{11})(?:\S+)?/i;
            const match = url.match(regExp);
            return (match && match[1]) ? match[1] : null;
        }

        /**
         * Obtém um título genérico para o vídeo com base no ID.
         * @param {string} url - A URL do vídeo.
         * @returns {string} O título do vídeo.
         */
        function getVideoTitle(url) {
            const videoId = extractVideoId(url);
            return videoId ? `Vídeo (ID: ${videoId})` : 'Vídeo do YouTube'; // Ou você pode usar uma API para obter o título real
        }

        /**
         * Carrega e reproduz um vídeo no player do YouTube.
         * @param {string} videoUrl - A URL do vídeo a ser carregado.
         * @param {string} userName - O nome do usuário que adicionou o vídeo.
         */
        function updateVideoPlayer(videoUrl, userName) {
            const videoId = extractVideoId(videoUrl);

            if (videoId && player && typeof player.loadVideoById === 'function') {
                player.loadVideoById(videoId);
                document.getElementById('currentUser').textContent = userName;
                document.getElementById('currentVideoUrl').textContent = videoUrl;
            } else {
                console.error('URL do YouTube inválida ou player não pronto:', videoUrl);
                document.getElementById('currentUser').textContent = 'Nenhum vídeo em execução';
                document.getElementById('currentVideoUrl').textContent = 'Nenhuma URL disponível';
                if (player && typeof player.stopVideo === 'function') {
                    player.stopVideo();
                }
            }
        }

        /**
         * Função chamada quando o estado do player do YouTube muda.
         * Se o vídeo terminar, ele remove o vídeo atual da fila do Firebase.
         * O listener 'value' do Firebase se encarrega de carregar o próximo.
         * @param {Object} event - O objeto de evento do player do YouTube.
         */
        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.ENDED) {
                if (videoQueue.length > 0) {
                    const finishedVideoId = videoQueue[0].id; // Remove o primeiro vídeo da fila
                    videoQueueRef.child(finishedVideoId).remove()
                        .then(() => {
                            console.log('Vídeo concluído removido do Firebase.');
                        })
                        .catch(error => {
                            console.error('Erro ao remover vídeo concluído do Firebase:', error);
                            showNotification('Erro ao remover vídeo concluído.', 'error');
                        });
                }
            }
        }

        /**
         * Função chamada quando a API do YouTube Iframe está pronta.
         * Inicializa o player e carrega a fila de vídeos.
         */
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('videoPlayer', {
                height: '100%',
                width: '100%',
                playerVars: {
                    'autoplay': 1,
                    'controls': 1,
                    'modestbranding': 1,
                    'rel': 0
                },
                events: {
                    'onReady': (event) => {
                        loadVideoQueue(); // Chamar loadVideoQueue APENAS quando o player está pronto
                    },
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        /**
         * Abre o modal para limpar a fila.
         */
        function openModal() {
            document.getElementById('modal').style.display = 'flex';
            document.getElementById('adminName').focus();
        }

        /**
         * Fecha o modal para limpar a fila e limpa os campos.
         */
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            document.getElementById('adminName').value = '';
            document.getElementById('clearPassword').value = '';
        }

        /**
         * Abre o modal para remover um vídeo específico.
         * @param {string} id - O ID (chave do Firebase) do vídeo a ser removido.
         */
        function openRemoveModalWithId(id) {
            videoToRemoveId = id; // Armazena o ID do Firebase key, que é uma string
            document.getElementById('removeModal').style.display = 'flex';
            document.getElementById('removeAdminName').focus();
        }

        /**
         * Fecha o modal para remover um vídeo e limpa os campos.
         */
        function closeRemoveModal() {
            document.getElementById('removeModal').style.display = 'none';
            document.getElementById('removeAdminName').value = '';
            document.getElementById('removePassword').value = '';
            videoToRemoveId = null; // Reseta o ID do vídeo a ser removido
        }

        /**
         * Limpa toda a fila de vídeos no Firebase Realtime Database.
         * Requer credenciais de administrador.
         */
        async function clearQueue() {
            const adminName = document.getElementById('adminName').value.trim();
            const password = document.getElementById('clearPassword').value;

            // Credenciais de administrador (AINDA HARDCODED - NÃO SEGURO PARA PRODUÇÃO!)
            const adminCredentials = {
                'Joao': 'pebinha',
                'HaazR': 'Dez'
            };

            if (!adminName || !password) {
                showNotification('Por favor, preencha todos os campos.', 'error');
                return;
            }

            if (adminCredentials[adminName] === password) {
                toggleLoading('clearQueueBtn', true);

                try {
                    await videoQueueRef.remove();
                    showNotification('Fila limpa com sucesso!', 'success');
                    closeModal();
                } catch (error) {
                    console.error('Erro ao limpar fila no Firebase:', error);
                    showNotification('Erro ao limpar a fila. Verifique a conexão com o Firebase.', 'error');
                } finally {
                    toggleLoading('clearQueueBtn', false);
                }
            } else {
                showNotification('Nome ou senha incorretos. Tente novamente.', 'error');
            }
        }

        /**
         * Remove um vídeo específico da fila no Firebase Realtime Database.
         * Requer credenciais de administrador.
         */
        async function removeVideo() {
            const adminName = document.getElementById('removeAdminName').value.trim();
            const password = document.getElementById('removePassword').value;

            // Credenciais de administrador (AINDA HARDCODED - NÃO SEGURO PARA PRODUÇÃO!)
            const adminCredentials = {
                'Joao': 'pebinha',
                'HaazR': 'Dez'
            };

            if (!adminName || !password) {
                showNotification('Por favor, preencha todos os campos.', 'error');
                return;
            }

            if (adminCredentials[adminName] === password) {
                if (videoToRemoveId !== null) {
                    toggleLoading('removeVideoBtn', true);

                    try {
                        await videoQueueRef.child(videoToRemoveId).remove();
                        showNotification('Vídeo removido com sucesso!', 'success');
                        closeRemoveModal();
                    } catch (error) {
                        console.error('Erro ao remover vídeo do Firebase:', error);
                        showNotification('Erro ao remover o vídeo. Verifique a conexão com o Firebase.', 'error');
                    } finally {
                        toggleLoading('removeVideoBtn', false);
                    }
                } else {
                    showNotification('Nenhum vídeo selecionado para remoção.', 'error');
                }
            } else {
                showNotification('Nome ou senha incorretos. Tente novamente.', 'error');
            }
        }

        // Event listeners para alternar a visibilidade da senha nos modais
        document.getElementById('togglePassword').addEventListener('click', function () {
            const passwordField = document.getElementById('clearPassword');
            const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordField.setAttribute('type', type);
            this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
        });

        document.getElementById('toggleRemovePassword').addEventListener('click', function () {
            const passwordField = document.getElementById('removePassword');
            const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordField.setAttribute('type', type);
            this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
        });

        // Fecha os modais se o usuário clicar fora do conteúdo do modal
        window.addEventListener('click', function(event) {
    if (event.target.classList.contains('modal')) {
        closeModal();
        closeRemoveModal();
        closeYTSearchModal(); // Adicione esta linha
    }
});

        // Fecha os modais se o usuário pressionar a tecla 'Escape'
        document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeModal();
        closeRemoveModal();
        closeYTSearchModal(); // Adicione esta linha
    }
});

        // Efeito de fade-in na carga da página
        document.addEventListener('DOMContentLoaded', function() {
            document.body.style.opacity = '0';
            setTimeout(() => {
                document.body.style.transition = 'opacity 0.5s ease';
                document.body.style.opacity = '1';
            }, 100);
        });
    </script>
</body>
</html>
