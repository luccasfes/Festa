<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <link rel="icon" type="image/x-icon" href="assets/favicon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a237e">
    <title>FlowLink</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <!-- Emonjis biblioteca -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.18.0/index.css" />
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.18.0/index.js"></script>
</head>

<body class="non-admin" style="opacity: 0; transition: opacity 0.5s ease;">
    <div id="particles"></div>
    <div class="container">

        <header class="app-header">
            <div class="header-controls-left">
                <button class="btn small" id="adminUnlockBtn" onclick="openAdminUnlockModal()">
                    <i class="fas fa-lock"></i>
                    <span id="adminStatusText">Admin</span>
                    <span id="adminNameDisplay" style="margin-left: 5px; display: none;"></span>
                </button>

                <button class="btn small" id="panelBtn" onclick="FuncaoParaAbrirPainel()" style="display: none;">
                    <i class="fas fa-cog"></i> <span>Painel</span>
                </button>
                <button class="btn small secondary" onclick="openThemeModal()" title="Mudar Tema">
                    <i class="fas fa-palette"></i>
                </button>
            </div>
            <h1><i class="fas fa-music"></i> FlowLink<i class="fas fa-headphones"></i></h1>
            <div class="room-details">
                <span id="roomNameDisplay">Carregando sala...</span>
                (Criada por: <span id="roomCreatorDisplay">...</span>)
            </div>
            <div class="presence-indicator">
                <i class="fas fa-users"></i>
                <span id="userCount">0</span> online
            </div>
        </header>

        <main class="main-layout">

            <section class="input-section card">
                <h2><i class="fas fa-plus-circle"></i> Adicionar Vídeo</h2>
                <div class="input-group">
                    <label for="phone"><i class="fas fa-user"></i> Nome:</label>
                    <input type="text" id="phone" placeholder="Quem adicionou?" required>
                </div>
                <div class="input-group">
                    <label for="videoUrl"><i class="fab fa-youtube"></i> URL do Vídeo:</label>
                    <input type="text" id="videoUrl" placeholder="Link do YouTube" required>
                </div>
                <button class="btn primary" onclick="addVideo()" id="addVideoBtn">
                    <span id="addBtnText">Adicionar à Fila</span>
                    <span id="addBtnLoader" class="loading" style="display: none;"></span>
                </button>
                <button class="btn youtube" onclick="openYTSearchModal()">
                    <i class="fab fa-youtube"></i> Buscar no YouTube
                </button>
            </section>

            <section class="video-player-section card">
                <h2><i class="fas fa-play-circle"></i> Vídeo em Execução</h2>
                <div id="player-container">
                    <div id="videoPlayer"></div>
                    <div id="player-mask"></div>
                    <div class="player-overlay-controls" aria-hidden="false">
                        <button id="overlayPlayBtn" title="Play/Pause"><i id="overlayPlayIcon"
                                class="fas fa-play"></i></button>
                        <label for="overlayVolume" style="color:var(--text-secondary);font-size:0.9rem;">Vol</label>
                        <input id="overlayVolume" type="range" min="0" max="100" step="1" value="50">
                        <button id="overlayFullscreenBtn" title="Tela cheia"><i class="fas fa-expand"></i></button>
                    </div>
                </div>
                <div id="currentVideoInfo">
                    <h3>Escolha de: <span id="currentUser">Nenhum vídeo em execução</span></h3>
                    <p class="current-url" id="currentVideoUrl" style="display:none;"></p>
                </div>
                <button class="btn primary skip-video-button" onclick="handleSkipOrVote()" id="skipVoteBtn">
                    <i class="fas fa-forward"></i>
                    <span id="skipVoteBtnText">Votar para Pular</span>
                    <span id="voteCounterWrapper">(<span id="voteCount">0</span>/<span id="votesNeeded">0</span>)</span>
                    <span id="skipVoteBtnLoader" class="loading" style="display: none;"></span>
                </button>
            </section>

            <section class="queue-section card">
                <h2>
                    <i class="fas fa-list-ol"></i> Fila de Música
                    <button class="btn danger clear-queue-button" onclick="handleClearQueue()" style="display:none;">
                        <i class="fas fa-trash-alt"></i> Limpar Fila
                    </button>
                    <button class="btn bulk-remove-button" onclick="removeSelectedVideos()" id="bulkRemoveBtn"
                        style="display: none;">
                        <i class="fas fa-eraser"></i> Remover Selecionados
                    </button>
                    <button id="btn-auto-sugestao" class="btn-sugestao" onclick="openSugestaoModal()"
                        style="display:none;">
                        <i class="fas fa-magic"></i> Sugerir Música
                    </button>
                </h2>
                <ul id="videoList" class="video-queue-list"></ul>
            </section>

            <section class="chat-section card">
                <h2><i class="fas fa-comments"></i> Chat da Música</h2>
                <button class="btn danger small" onclick="handleClearChat()" id="clearChatBtn" style="display: none;">
                    <i class="fas fa-eraser"></i> Limpar Chat
                </button>

                <div class="chat-users-online">
                    <div class="online-indicator">
                        <div class="online-dot"></div>
                        <span id="onlineCount">1</span> usuário(s) online
                    </div>
                    <div class="user-info">
                        <span id="userNameDisplay">Visitante</span>
                        <button class="btn small secondary" onclick="openEditNameModal()" style="margin-left: 10px;"
                            title="Alterar seu nome">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                </div>

                <!-- Container das mensagens -->
                <div id="chatMessages" class="chat-messages-list">
                    <div class="empty-chat"><i class="fas fa-comment-slash"></i>
                        <p>Nenhuma mensagem ainda.</p>
                    </div>
                </div>

                <!-- Indicador de novas mensagens (fixo no HTML ou criado via JS) -->
                <div id="newMessagesIndicator" class="new-messages-indicator"
                    style="display: none; position: sticky; bottom: 10px; margin: 10px auto; text-align: center;">
                    <button class="btn small primary" onclick="scrollToBottom()">
                        <span id="newMessagesCount">0</span> nova(s) mensagem(ns) <i class="fas fa-arrow-down"></i>
                    </button>
                </div>

                <div class="typing-indicator" id="typingIndicator">
                    <span id="typingUser"></span> está digitando<span
                        class="typing-dots"><span>.</span><span>.</span><span>.</span></span>
                </div>

                <div class="chat-actions-bar" id="chatActionsBar" style="display: none;">
                    <div class="chat-reply-context" id="chatReplyContext" style="display: none;">
                        <div class="chat-reply-info">
                            <span class="chat-reply-user"></span>
                            <span class="chat-reply-text"></span>
                        </div>
                        <button class="chat-reply-cancel" onclick="cancelReply()">&times;</button>
                    </div>
                </div>

                <div class="chat-input-group">
                    <!-- Botão de emoji opcional -->
                    <button type="button" class="btn small" id="emojiBtn" title="Emojis">
                        <i class="far fa-smile"></i>
                    </button> <input type="text" id="chatMessageInput" placeholder="Digite sua mensagem..."
                        onkeypress="handleChatInput(event)">

                    <button class="btn primary" onclick="sendChatMessage()" title="Enviar">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal do Emonji -->
    <div id="emojiModal" class="emoji-modal" style="display: none;">
        <div class="emoji-modal-content">
            <emoji-picker id="emojiPicker"></emoji-picker>
            <button class="btn small danger" onclick="closeEmojiPicker()">Fechar</button>
        </div>
    </div>

    <div id="adminUnlockModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeAdminUnlockModal()">×</span>
            <h3>Login Admin</h3>
            <div class="input-group"><input type="email" id="adminUnlockName" placeholder="E-mail"></div>
            <div class="input-group password-group">
                <input type="password" id="adminUnlockPassword" placeholder="Senha">
                <span id="toggleAdminUnlockPassword"><i class="fas fa-eye"></i></span>
            </div>
            <button class="btn primary" onclick="loginAdminSession()" id="adminUnlockConfirmBtn">Login</button>
        </div>
    </div>

    <div id="editNameModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeEditNameModal()">×</span>
            <h3>Alterar Nome</h3>
            <div class="input-group"><input type="text" id="editNameInput" maxlength="25"></div>
            <button class="btn primary" onclick="saveUserName()" id="saveUserNameBtn">Salvar</button>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">×</span>
            <h3>Limpar Fila</h3>
            <p>Admin e senha necessários.</p>
            <div class="input-group"><input type="email" id="adminName" placeholder="E-mail"></div>
            <div class="input-group password-group"><input type="password" id="clearPassword" placeholder="Senha"></div>
            <button class="btn primary" onclick="clearQueue()" id="clearQueueBtn">Confirmar</button>
        </div>
    </div>

    <div id="removeModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeRemoveModal()">×</span>
            <h3>Remover Vídeo</h3>
            <div class="input-group"><input type="email" id="removeAdminName" placeholder="E-mail"></div>
            <div class="input-group password-group"><input type="password" id="removePassword" placeholder="Senha">
            </div>
            <button class="btn primary" onclick="removeVideo()" id="removeVideoBtn">Confirmar</button>
        </div>
    </div>

    <div id="nextVideoModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeNextVideoModal()">×</span>
            <h3>Próximo Vídeo</h3>
            <div class="input-group"><input type="email" id="nextAdminName" placeholder="E-mail"></div>
            <div class="input-group password-group"><input type="password" id="nextPassword" placeholder="Senha"></div>
            <button class="btn primary" onclick="playNextVideo()" id="playNextVideoBtn">Confirmar</button>
        </div>
    </div>

    <div id="bulkRemoveConfirmModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeBulkRemoveConfirmModal()">×</span>
            <h3>Confirmar Remoção</h3>
            <p id="bulkRemoveMessage"></p>
            <button class="btn danger" onclick="executeBulkRemove()" id="bulkRemoveConfirmBtn">Remover</button>
        </div>
    </div>

    <div id="ytSearchModal" class="modal yt-search-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Buscar no YouTube</h3>
                <span class="close-button" onclick="closeYTSearchModal()">×</span>
            </div>
            <div class="modal-body">
                <div class="session-info input-group" style="display:none;">
                    <label>Como: <strong id="currentSessionUser">-</strong></label>
                    <button class="btn small secondary" onclick="changeUserName()">Alterar</button>
                </div>
                <div id="userNameInputGroup" class="input-group">
                    <label>Seu Nome:</label> <input type="text" id="ytSearchName">
                    <button class="btn small primary" onclick="setSessionUser()">OK</button>
                </div>
                <div class="search-controls">
                    <input type="text" id="ytSearchQuery" placeholder="Busca...">
                    <button class="btn primary" onclick="searchYouTube()">Buscar</button>
                </div>
                <div id="ytSearchResults"></div>
            </div>
        </div>
    </div>

    <div id="sugestaoModal" class="modal sugestao-modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeSugestaoModal()">×</span>
            <h3><i class="fas fa-magic"></i> Sugestão Inteligente</h3>
            <div class="sugestao-tabs">
                <button class="sugestao-tab active" onclick="switchTab('genero')"><i class="fas fa-music"></i> Por
                    Gênero</button>
                <button class="sugestao-tab" onclick="switchTab('similar')"><i class="fas fa-random"></i>
                    Similares</button>
                <button class="sugestao-tab" onclick="switchTab('tendencia')"><i class="fas fa-chart-line"></i>
                    Tendências</button>
            </div>
            <div id="generoContent" class="tab-content active">
                <div class="generos-container">
                    <button class="genero-btn" onclick="selectGenero('sertanejo')" data-genero="sertanejo"><i
                            class="fas fa-guitar"></i> Sertanejo</button>
                    <button class="genero-btn" onclick="selectGenero('funk')" data-genero="funk"><i
                            class="fas fa-fire"></i> Funk</button>
                    <button class="genero-btn" onclick="selectGenero('pop')" data-genero="pop"><i
                            class="fas fa-star"></i> Pop</button>
                    <button class="genero-btn" onclick="selectGenero('rock')" data-genero="rock"><i
                            class="fas fa-guitar"></i> Rock</button>
                    <button class="genero-btn" onclick="selectGenero('eletronica')" data-genero="eletronica"><i
                            class="fas fa-bolt"></i> Eletrônica</button>
                    <button class="genero-btn" onclick="selectGenero('rap')" data-genero="rap"><i
                            class="fas fa-microphone"></i> Rap/Hip-Hop</button>
                    <button class="genero-btn" onclick="selectGenero('reggaeton')" data-genero="reggaeton"><i
                            class="fas fa-fire"></i> Reggaeton</button>
                    <button class="genero-btn" onclick="selectGenero('pagode')" data-genero="pagode"><i
                            class="fas fa-drum"></i> Pagode</button>
                </div>
            </div>
            <div id="similarContent" class="tab-content" style="display:none; text-align:center; padding:20px;">
                <p>Sugestões baseadas no que está tocando agora.</p>
            </div>
            <div id="tendenciaContent" class="tab-content" style="display:none; text-align:center; padding:20px;">
                <p>As músicas mais tocadas do momento no Brasil.</p>
            </div>
            <div class="autoplay-controls">
                <div class="autoplay-option">
                    <span>Ligar Auto DJ</span>
                    <label class="switch"><input type="checkbox" id="autoAddToggle"
                            onchange="ativarAutoSugestao()"><span class="slider"></span></label>
                </div>
                <div class="autoplay-option">
                    <span>Manter na fila:</span>
                    <div class="autoplay-count">
                        <button class="count-btn" onclick="changeAutoCount(-1)">-</button>
                        <span class="count-display" id="autoCount">1</span>
                        <button class="count-btn" onclick="changeAutoCount(1)">+</button>
                    </div>
                </div>
            </div>
            <div class="sugestao-actions">
                <button class="btn btn-now" onclick="sugerirAgora()"><i class="fas fa-plus-circle"></i> Adicionar
                    Agora</button>
                <button class="btn btn-auto" onclick="toggleAutoDjBtn()"><i class="fas fa-play-circle"></i> Auto
                    (Ligar/Desligar)</button>
            </div>
        </div>
    </div>

    <div id="themeModal" class="modal" style="display:none; opacity:0;">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h3><i class="fas fa-palette"></i> Personalizar Tema</h3>
                <span class="close-button" onclick="closeThemeModal()">×</span>
            </div>
            <div class="theme-grid">
                <div class="theme-btn" onclick="applyTheme('default')" id="theme-btn-default">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #4e54c8 0%, #1a1a2e 100%);">
                    </div>
                    <span>Padrão</span> <small>Clássico</small>
                </div>
                <div class="theme-btn" onclick="applyTheme('pink')" id="theme-btn-pink">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #ff007f 0%, #2d0a1e 100%);">
                    </div>
                    <span>Pink</span> <small>Vibrante</small>
                </div>
                <div class="theme-btn" onclick="applyTheme('light')" id="theme-btn-light">
                    <div class="theme-preview" style="background: #f0f2f5; border:1px solid #ddd;"></div>
                    <span>Claro</span> <small>Clean</small>
                </div>
                <div class="theme-btn" onclick="applyTheme('oled')" id="theme-btn-oled">
                    <div class="theme-preview" style="background: #000;"></div>
                    <span>Dark</span> <small>OLED</small>
                </div>
            </div>
            <div style="margin-top:20px; border-top:1px solid #ffffff20; padding-top:10px;">
                <button onclick="resetToDefault()"
                    style="background:none; border:none; color:#aaa; cursor:pointer;">Redefinir</button>
            </div>
        </div>
    </div>

    <div id="panelModal" class="modal admin-panel-modal">
        <div class="modal-content">
            <span class="close-button" onclick="closePanelModal()">×</span>

            <div class="admin-panel-header">
                <h3><i class="fas fa-user-shield"></i> Painel Admin - FlowLink</h3>
            </div>

            <div class="admin-panel-body">
                <h4 style="display: flex; justify-content: space-between; align-items: center;">
                    <span><i class="fas fa-server"></i> Salas Ativas</span>

                    <div style="display: flex; align-items: center;">
                        <button class="btn small secondary" onclick="loadAdminPanelRooms()" title="Atualizar lista">
                            <i class="fas fa-sync-alt"></i> Atualizar
                        </button>

                        <a href="admin.html" target="_blank" class="btn small secondary"
                            style="margin-left: 10px; text-decoration: none; display: inline-flex; align-items: center; justify-content: center;"
                            title="Abrir Painel Completo">
                            <i class="fas fa-external-link-alt" style="margin-right: 5px;"></i> Abrir Admin
                        </a>

                        <button class="btn small danger" onclick="openDeleteAllRoomsModal()"
                            title="Deletar TODAS as salas" style="margin-left: 10px;">
                            <i class="fas fa-exclamation-triangle"></i> Deletar Tudo
                        </button>
                    </div>
                </h4>

                <div id="adminRoomLoader" class="loading-yt" style="display: none; padding: 40px 0;">
                    Carregando salas...
                </div>

                <div id="adminRoomList" class="admin-room-list">
                </div>
            </div>
        </div>
    </div>

    <div id="deleteAllRoomsModal" class="modal">
        <div class="modal-content"><span class="close-button" onclick="closeDeleteAllRoomsModal()">×</span>
            <h3>Deletar Tudo?</h3><button class="btn danger" onclick="executeDeleteAllRooms()"
                id="deleteAllRoomsConfirmBtn">Sim</button>
        </div>
    </div>

    <div id="notification" class="notification"><span id="notificationMessage"></span></div>

    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/session.js"></script>
    <script src="js/presence.js"></script>
    <script src="js/queue.js"></script>
    <script src="js/search.js"></script>
    <script src="js/chat.js"></script>
    <script src="js/admin.js"></script>
    <script src="js/theme.js"></script>
    <script src="js/player.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => { document.body.style.opacity = '1'; }, 100);
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(() => { });
            });
        }
    </script>
</body>

</html>